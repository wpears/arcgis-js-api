/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
require({cache:{"esri/layers/FeatureEditResult":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","esri/kernel"],function(k,c,q,h){k=k(null,{declaredClass:"esri.layers.FeatureEditResult",constructor:function(h){h&&c.isObject(h)&&(this.objectId=h.objectId,this.success=h.success,h.success||(h=h.error,this.error=Error(),this.error.code=h.code,this.error.message=h.description))}});q("extend-esri")&&c.setObject("layers.FeatureEditResult",k,h);return k})},"esri/layers/MapImageLayer":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/dom-construct dojo/dom-style esri/kernel esri/config esri/sniff esri/domUtils esri/geometry/Point esri/geometry/webMercatorUtils esri/layers/layer".split(" "),
function(k,c,q,h,r,p,g,n,b,m,l,a,s){var e=k([s],{declaredClass:"esri.layers.MapImageLayer","-chains-":{constructor:"manual"},constructor:function(f){this.inherited(arguments,[null,f]);this._mapImages=[];var d=q.hitch;this._panStart=d(this,this._panStart);this._pan=d(this,this._pan);this._extentChange=d(this,this._extentChange);this._zoom=d(this,this._zoom);this._zoomStart=d(this,this._zoomStart);this._scale=d(this,this._scale);this._resize=d(this,this._resize);c.connect(this,"onSuspend",this,this._onSuspend);
c.connect(this,"onResume",this,this._onResume);this.loaded=!0;this.onLoad(this)},opacity:1,_transform:g._getDOMAccessor("transform"),addImage:function(f){var d=this._mapImages.push(f),d=d-1;f._idx=d;f._layer=this;this._div&&this._createImage(f,d)},removeImage:function(f){if(f){var d=f._idx,e=this._mapImages;if(e[d]===f){delete e[d];if(d=f._node)this._clearEvents(d),d.e_idx=d.e_bl=d.e_tr=d.e_l=d.e_t=d.e_w=d.e_h=null,d.parentNode&&(d.parentNode.removeChild(d),r.destroy(d));f._node=f._idx=f._layer=null}}},
removeAllImages:function(){var f=this._mapImages,d,e=f.length;for(d=0;d<e;d++){var a=f[d];a&&this.removeImage(a)}this._mapImages=[]},getImages:function(){var f=this._mapImages,d=[],e,a=f.length;for(e=0;e<a;e++)f[e]&&d.push(f[e]);return d},setOpacity:function(f){this.opacity!=f&&(this._opacityChanged(this.opacity=f),this.onOpacityChange())},onOpacityChange:function(){},_opacityChanged:function(f){var d=this._div,e,a;if(d)if(!b("ie")||8<b("ie"))p.set(d,"opacity",f);else{a=d.childNodes;e=a.length;for(d=
0;d<e;d++)p.set(a[d],"opacity",f)}},_createImage:function(f,d){var a=r.create("img");p.set(a,{position:"absolute"});8>=b("ie")&&p.set(a,"opacity",this.opacity);if(f.rotation){var g="rotate("+(360-f.rotation)+"deg)";9>b("ie")||(p.set(a,this._transform,g),p.set(a,"transform",g))}f._node=a;a.e_idx=d;a.e_layer=this;a.e_load=c.connect(a,"onload",e.prototype._imageLoaded);a.e_error=c.connect(a,"onerror",e.prototype._imageError);a.e_abort=c.connect(a,"onabort",e.prototype._imageError);a.src=f.href},_imageLoaded:function(f,
d){var a=d||f.target||f.currentTarget,e=a.e_layer,b=e._mapImages[a.e_idx],g=e._map;g&&(g.__zooming||g.__panning||!e._sr)?e._standby.push(a):(e._clearEvents(a),b&&b._node===a&&g&&e._attach(b))},_imageError:function(f){f=f.target||f.currentTarget;var d=f.e_layer,a=d._mapImages[f.e_idx];d._clearEvents(f);a&&(a._node=null)},_clearEvents:function(f){var d=c.disconnect;d(f.e_load);d(f.e_error);d(f.e_abort);f.e_load=f.e_error=f.e_abort=f.e_layer=null},_attach:function(f){var d=f.extent,e=d.spatialReference,
b=this._sr,g=this._div,c=f._node,s=new l({x:d.xmin,y:d.ymin,spatialReference:e}),d=new l({x:d.xmax,y:d.ymax,spatialReference:e});b.equals(e)||(b.isWebMercator()&&4326===e.wkid?(s=a.geographicToWebMercator(s),d=a.geographicToWebMercator(d)):e.isWebMercator()&&4326===b.wkid&&(s=a.webMercatorToGeographic(s),d=a.webMercatorToGeographic(d)));c.e_bl=s;c.e_tr=d;f.visible&&(this._setPos(c,g._left,g._top),(this._active||g).appendChild(c))},_setPos:function(f,d,a){var e=f.e_bl,b=f.e_tr,l=this._map,e=l.toScreen(e),
b=l.toScreen(b);d=e.x-d;a=b.y-a;var c=Math.abs(b.x-e.x),e=Math.abs(e.y-b.y),b={width:c+"px",height:e+"px"},s=this._mapImages[f.e_idx];"css-transforms"===l.navigationMode?b[g._css.names.transform]=g._css.translate(d,a)+(s.rotation?" "+g._css.rotate(360-s.rotation):""):(b.left=d+"px",b.top=a+"px");p.set(f,b);f.e_l=d;f.e_t=a;f.e_w=c;f.e_h=e},managedSuspension:!0,_setMap:function(f,d){this.inherited(arguments);var a=this._div=r.create("div",null,d),e=g._css.names,l={position:"absolute"},c=f.__visibleDelta;
if(!b("ie")||8<b("ie"))l.opacity=this.opacity;"css-transforms"===f.navigationMode?(l[e.transform]=g._css.translate(c.x,c.y),p.set(a,l),a._left=c.x,a._top=c.y,l={position:"absolute",width:f.width+"px",height:f.height+"px",overflow:"visible"},this._active=r.create("div",null,a),p.set(this._active,l),this._passive=r.create("div",null,a),p.set(this._passive,l)):(a._left=0,a._top=0,p.set(a,l));this._standby=[];e=this._mapImages;c=e.length;for(l=0;l<c;l++){var s=e[l];s._node||this._createImage(s,s._idx)}m.hide(a);
return a},_unsetMap:function(f,d){this._disconnect();var a=this._div;if(a){var e=this._mapImages,b,g=e.length;for(b=0;b<g;b++){var l=e[b];if(l){var c=l._node;c&&(this._clearEvents(c),c.e_idx=c.e_bl=c.e_tr=c.e_l=c.e_t=c.e_w=c.e_h=null);l._node=null}}d.removeChild(a);r.destroy(a)}this._map=this._div=this._sr=this._active=this._passive=this._standby=null;this.inherited(arguments)},_onSuspend:function(){this._disconnect();m.hide(this._div)},_onResume:function(f){f.firstOccurrence&&(this._sr=this._map.spatialReference,
this._processStandbyList());f=this._map;var d=this._div,a=f.__visibleDelta;"css-transforms"===f.navigationMode&&(d._left=a.x,d._top=a.y,p.set(d,g._css.names.transform,g._css.translate(d._left,d._top)));this._redraw("css-transforms"===f.navigationMode);this._connect(f);m.show(d)},_connect:function(f){if(!this._connections){var d=c.connect,a="css-transforms"===f.navigationMode;this._connections=[d(f,"onPanStart",this._panStart),d(f,"onPan",this._pan),d(f,"onExtentChange",this._extentChange),a&&d(f,
"onZoomStart",this._zoomStart),a?d(f,"onScale",this._scale):d(f,"onZoom",this._zoom),a&&d(f,"onResize",this._resize)]}},_disconnect:function(){this._connections&&(h.forEach(this._connections,c.disconnect),this._connections=null)},_panStart:function(){this._panL=this._div._left;this._panT=this._div._top},_pan:function(f,d){var a=this._div;a._left=this._panL+d.x;a._top=this._panT+d.y;"css-transforms"===this._map.navigationMode?p.set(a,g._css.names.transform,g._css.translate(a._left,a._top)):p.set(a,
{left:a._left+"px",top:a._top+"px"})},_extentChange:function(f,d,a){a?this._redraw("css-transforms"===this._map.navigationMode):d&&this._pan(f,d);this._processStandbyList()},_processStandbyList:function(){var a,d=this._standby;if(d&&d.length)for(a=d.length-1;0<=a;a--)this._imageLoaded(null,d[a]),d.splice(a,1)},_redraw:function(a){if(a){a=this._passive;var d=g._css.names;p.set(a,d.transition,"none");this._moveImages(a,this._active);p.set(a,d.transform,"none")}a=this._active||this._div;var d=this._div._left,
e=this._div._top,b,l=a.childNodes.length,c;for(b=0;b<l;b++)c=a.childNodes[b],this._setPos(c,d,e)},_zoom:function(a,d,e){a=this._div;var b=a._left,l=a._top,g,c=a.childNodes.length,s;for(g=0;g<c;g++){s=a.childNodes[g];var m=s.e_w*d,u=s.e_h*d,n=(e.x-b-s.e_l)*(m-s.e_w)/s.e_w,h=(e.y-l-s.e_t)*(u-s.e_h)/s.e_h,n=isNaN(n)?0:n,h=isNaN(h)?0:h;p.set(s,{left:s.e_l-n+"px",top:s.e_t-h+"px",width:m+"px",height:u+"px"})}},_zoomStart:function(){this._moveImages(this._active,this._passive)},_moveImages:function(a,d){var e=
a.childNodes,b;b=e.length;if(0<b)for(b-=1;0<=b;b--)d.appendChild(e[b])},_scale:function(a,d){var e=g._css.names,b=this._passive;p.set(b,e.transition,d?"none":e.transformName+" "+n.defaults.map.zoomDuration+"ms ease");g._css.matrix(a);p.set(b,e.transform,g._css.matrix(a))},_resize:function(a,d,e){p.set(this._active,{width:d+"px",height:e+"px"});p.set(this._passive,{width:d+"px",height:e+"px"})}});b("extend-esri")&&q.setObject("layers.MapImageLayer",e,g);return e})},"esri/layers/WebTiledLayer":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/url dojo/has dojo/string esri/kernel esri/urlUtils esri/SpatialReference esri/geometry/Extent esri/layers/TiledMapServiceLayer esri/layers/TileInfo".split(" "),
function(k,c,q,h,r,p,g,n,b,m,l,a){k=k(l,{declaredClass:"esri.layers.WebTiledLayer",constructor:function(g,e){e||(e={});this.urlTemplate=g;var f=new m(-2.0037508342787E7,-2.003750834278E7,2.003750834278E7,2.0037508342787E7,new b({wkid:102100})),d=new m(-2.0037508342787E7,-2.003750834278E7,2.003750834278E7,2.0037508342787E7,new b({wkid:102100}));this.initialExtent=e.initialExtent||f;this.fullExtent=e.fullExtent||d;this.tileInfo=e.tileInfo?e.tileInfo:new a({rows:256,cols:256,origin:{x:-2.0037508342787E7,
y:2.0037508342787E7},spatialReference:{wkid:102100},lods:[{level:0,resolution:156543.033928,scale:5.91657527591555E8},{level:1,resolution:78271.5169639999,scale:2.95828763795777E8},{level:2,resolution:39135.7584820001,scale:1.47914381897889E8},{level:3,resolution:19567.8792409999,scale:7.3957190948944E7},{level:4,resolution:9783.93962049996,scale:3.6978595474472E7},{level:5,resolution:4891.96981024998,scale:1.8489297737236E7},{level:6,resolution:2445.98490512499,scale:9244648.868618},{level:7,resolution:1222.99245256249,
scale:4622324.434309},{level:8,resolution:611.49622628138,scale:2311162.217155},{level:9,resolution:305.748113140558,scale:1155581.108577},{level:10,resolution:152.874056570411,scale:577790.554289},{level:11,resolution:76.4370282850732,scale:288895.277144},{level:12,resolution:38.2185141425366,scale:144447.638572},{level:13,resolution:19.1092570712683,scale:72223.819286},{level:14,resolution:9.55462853563415,scale:36111.909643},{level:15,resolution:4.77731426794937,scale:18055.954822},{level:16,resolution:2.38865713397468,
scale:9027.977411},{level:17,resolution:1.19432856685505,scale:4513.988705},{level:18,resolution:0.597164283559817,scale:2256.994353},{level:19,resolution:0.298582141647617,scale:1128.497176}]});this.spatialReference=new b(this.tileInfo.spatialReference.toJson());this.copyright=e.copyright||"";var l=new h(g),f=l.scheme+"://"+l.authority+"/";this.urlPath=g.substring(f.length);this.tileServers=e.tileServers||[];-1===l.authority.indexOf("{subDomain}")&&this.tileServers.push(f);if(e.subDomains&&0<e.subDomains.length&&
1<l.authority.split(".").length){this.subDomains=e.subDomains;var c;q.forEach(e.subDomains,function(a,d){-1<l.authority.indexOf("${subDomain}")?c=l.scheme+"://"+p.substitute(l.authority,{subDomain:a})+"/":-1<l.authority.indexOf("{subDomain}")&&(c=l.scheme+"://"+l.authority.replace(/\{subDomain\}/gi,a)+"/");this.tileServers.push(c)},this)}this.tileServers=q.map(this.tileServers,function(a){"/"!==a.charAt(a.length-1)&&(a+="/");return a});this._levelToLevelValue=[];q.forEach(this.tileInfo.lods,function(a){this._levelToLevelValue[a.level]=
a.levelValue||a.level},this);this.loaded=!0;this.onLoad(this)},getTileUrl:function(a,e,f){a=this._levelToLevelValue[a];var d=this.tileServers[e%this.tileServers.length]+p.substitute(this.urlPath,{level:a,col:f,row:e}),d=d.replace(/\{level\}/gi,a).replace(/\{row\}/gi,e).replace(/\{col\}/gi,f),d=this.addTimestampToURL(d);return n.addProxy(d)}});r("extend-esri")&&c.setObject("layers.WebTiledLayer",k,g);return k})},"esri/layers/ServiceGeneratedFeatureCollection":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/dom-construct dojo/dom-style dojo/has esri/kernel esri/SpatialReference esri/geometry/Extent esri/geometry/webMercatorUtils esri/renderers/SimpleRenderer esri/layers/layer esri/layers/FeatureLayer esri/dijit/PopupTemplate".split(" "),
function(k,c,q,h,r,p,g,n,b,m,l,a,s,e,f){k=k([s],{declaredClass:"esri.layers._ServiceGeneratedFeatureCollection",constructor:function(a,e){this.pointSymbol=e&&e.pointSymbol;this.polylineSymbol=e&&e.polylineSymbol;this.polygonSymbol=e&&e.polygonSymbol;this._outSR=e&&(e.outSpatialReference||e.outSR)||new b({wkid:4326});this._options=e},parse:function(){console.error("parse function has not been implemented")},getFeatureLayers:function(){var a=[];this._fLayers&&(a=a.concat(this._fLayers));return a},onRefresh:function(){},
refresh:function(){this.loaded&&(this._map&&!this._io&&this.visible)&&this._createLayer()},_createLayer:function(a){var e=this;this._fireUpdateStart();a=this.parse(a);a.addCallback(function(a){e._io=null;e._initLayer(a)});a.addErrback(function(a){e._io=null;a=q.mixin(Error(),a);a.message="Unable to load resource: "+e.url+" "+(a.message||"");e._fireUpdateEnd(a);e.onError(a)})},_initLayer:function(d){this.loaded&&this._removeInternalLayers();this.name=d.name;this.description=d.description;this.snippet=
d.snippet;this.defaultVisibility=void 0!==d.visibility?this.visible=!!d.visibility:this.visible=!0;this.featureInfos=d.featureInfos;this.fullExtent=this.initialExtent=new m(d.lookAtExtent);this.copyright=d.author||d.copyright;var b;if((d=q.getObject("featureCollection.layers",!1,d))&&0<d.length)this._fLayers=[],h.forEach(d,function(a,d){var l=q.getObject("featureSet.features",!1,a);l&&0<l.length&&(b=q.mixin({outFields:["*"],infoTemplate:a.popupInfo?new f(a.popupInfo):null,editable:!1},this._options),
b.id&&(b.id=b.id+"_"+d),a.layerDefinition.capabilities="Query,Data",l=new e(a,b),l.geometryType&&(this["_"+l.geometryType]=l),this._fLayers.push(l))},this),0===this._fLayers.length&&delete this._fLayers;this.items=[];this._esriGeometryPoint&&(this.items=this.items.concat(this._esriGeometryPoint.graphics),this.pointSymbol&&(d=new a(this.pointSymbol),this._esriGeometryPoint.setRenderer(d)));this._esriGeometryPolyline&&(this.items=this.items.concat(this._esriGeometryPolyline.graphics),this.polylineSymbol&&
(d=new a(this.polylineSymbol),this._esriGeometryPolyline.setRenderer(d)));this._esriGeometryPolygon&&(this.items=this.items.concat(this._esriGeometryPolygon.graphics),this.polygonSymbol&&(d=new a(this.polygonSymbol),this._esriGeometryPolygon.setRenderer(d)));this._fireUpdateEnd();this.loaded&&(this._addInternalLayers(),this.onRefresh())},_addInternalLayers:function(){var a=this._map;this._fireUpdateStart();var e=a.spatialReference,f=this._outSR,b;if(e.wkid)b=e._isWebMercator()&&f._isWebMercator()||
e.wkid===f.wkid;else if(e.wkt)b=e.wkt===f.wkt;else{console.log("_setMap - map has invalid spatial reference");return}if(!b)if(e._isWebMercator()&&4326===f.wkid)this._converter=l.geographicToWebMercator;else if(f._isWebMercator()&&4326===e.wkid)this._converter=l.webMercatorToGeographic;else{console.log("_setMap - unsupported workflow. Spatial reference of the map and layer do not match, and the conversion cannot be done on the client.");return}(e=this._fLayers)&&0<e.length&&h.forEach(e,function(e){if(this._converter){var f=
e.graphics,b,l,g=f?f.length:0;for(b=0;b<g;b++)(l=f[b].geometry)&&f[b].setGeometry(this._converter(l))}a.addLayer(e)},this);this.setVisibility(this.visible);this._fireUpdateEnd()},_removeInternalLayers:function(){var a=this._map;a&&h.forEach(this.getFeatureLayers(),a.removeLayer,a)},onVisibilityChange:function(a){this._fireUpdateStart();h.forEach(this.getFeatureLayers(),function(e){e.setVisibility(a)});this._fireUpdateEnd()},_setMap:function(a,e){this.inherited(arguments);this._map=a;var f=this._div=
r.create("div",null,e);p.set(f,"position","absolute");this._addInternalLayers();this.evaluateSuspension();return f},_unsetMap:function(a,e){this._io&&this._io.cancel();c.disconnect(this._extChgHandle);delete this._extChgHandle;this._removeInternalLayers();var f=this._div;f&&(e.removeChild(f),r.destroy(f));this._div=null;this.inherited(arguments)}});g("extend-esri")&&q.setObject("layers._ServiceGeneratedFeatureCollection",k,n);return k})},"esri/layers/KMLGroundOverlay":function(){define("dojo/_base/declare dojo/_base/lang dojo/has esri/kernel esri/lang esri/layers/MapImage".split(" "),
function(k,c,q,h,r,p){k=k([p],{declaredClass:"esri.layers.KMLGroundOverlay",constructor:function(g){r.isDefined(this.visibility)&&(this.visible=!!this.visibility)}});q("extend-esri")&&c.setObject("layers.KMLGroundOverlay",k,h);return k})},"dojo/data/util/simpleFetch":function(){define(["../../_base/lang","../../_base/kernel","./sorter"],function(k,c,q){var h={};k.setObject("dojo.data.util.simpleFetch",h);h.errorHandler=function(h,p){p.onError&&p.onError.call(p.scope||c.global,h,p)};h.fetchHandler=
function(h,p){var g=p.abort||null,n=!1,b=p.start?p.start:0,m=p.count&&Infinity!==p.count?b+p.count:h.length;p.abort=function(){n=!0;g&&g.call(p)};var l=p.scope||c.global;p.store||(p.store=this);p.onBegin&&p.onBegin.call(l,h.length,p);p.sort&&h.sort(q.createSortFunction(p.sort,this));if(p.onItem)for(var a=b;a<h.length&&a<m;++a){var s=h[a];n||p.onItem.call(l,s,p)}p.onComplete&&!n&&(a=null,p.onItem||(a=h.slice(b,m)),p.onComplete.call(l,a,p))};h.fetch=function(c){c=c||{};c.store||(c.store=this);this._fetchItems(c,
k.hitch(this,"fetchHandler"),k.hitch(this,"errorHandler"));return c};return h})},"esri/layers/KMLLayer":function(){define("dojo/_base/kernel dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/sniff dojo/io-query dojo/dom-construct dojo/dom-style esri/kernel esri/config esri/lang esri/request esri/SpatialReference esri/geometry/webMercatorUtils esri/dijit/PopupTemplate esri/layers/layer esri/layers/KMLFolder esri/layers/KMLGroundOverlay esri/layers/MapImageLayer esri/layers/FeatureLayer".split(" "),
function(k,c,q,h,r,p,g,n,b,m,l,a,s,e,f,d,x,B,t,v,G,H){var y=c([B],{declaredClass:"esri.layers.KMLLayer",serviceUrl:location.protocol+"//utility.arcgis.com/sharing/kml",constructor:function(e,d){e||console.log("KMLLayer:constructor - please provide url for the KML file");this._outSR=d&&d.outSR||new f({wkid:4326});this._options=d;a.defaults.kmlService&&(this.serviceUrl=a.defaults.kmlService);var b=this.linkInfo=d&&d.linkInfo;b&&(this.visible=!!b.visibility,this._waitingForMap=!!b.viewFormat);(!b||b&&
b.visibility&&!this._waitingForMap)&&this._parseKml();this.refresh=h.hitch(this,this.refresh);this.registerConnectEvents("esri.layers.KMLLayer",!0)},getFeature:function(a){if(a){var e=a.type,d=a.id,f;switch(e){case "esriGeometryPoint":case "esriGeometryPolyline":case "esriGeometryPolygon":(a=this["_"+e])&&(f=h.getObject("_mode._featureMap."+d,!1,a));break;case "GroundOverlay":if(a=this._groundLyr){var b=a.getImages(),e=b.length;for(a=0;a<e;a++)if(b[a].id===d){f=b[a];break}}break;case "ScreenOverlay":break;
case "NetworkLink":r.some(this._links,function(a){return a.linkInfo&&a.linkInfo.id===d?(f=a,!0):!1});break;case "Folder":e=(b=this.folders)?b.length:0;for(a=0;a<e;a++)if(b[a].id===d){f=b[a];break}break;default:console.log("KMLLayer:getFeature - unknown feature type")}return f}},getLayers:function(){var a=[];this._groundLyr&&a.push(this._groundLyr);this._fLayers&&(a=a.concat(this._fLayers));this._links&&r.forEach(this._links,function(e){e.declaredClass&&a.push(e)});return a},setFolderVisibility:function(a,
e){a&&(this._fireUpdateStart(),(a.visible=e)&&(e=this._areLocalAncestorsVisible(a)),this._setState(a,e),this._fireUpdateEnd())},onRefresh:function(){},_parseKml:function(a){var d=this;this._fireUpdateStart();this._io=e({url:this.serviceUrl,content:{url:this._url.path+this._getQueryParameters(a),model:"simple",folders:"",refresh:this.loaded?!0:void 0,outSR:p.toJson(this._outSR.toJson())},callbackParamName:"callback",load:function(a){d._io=null;d._initLayer(a)},error:function(a){d._io=null;a=h.mixin(Error(),
a);a.message="Unable to load KML: "+d.url+" "+(a.message||"");d._fireUpdateEnd(a);d.onError(a)}})},_initLayer:function(a){this.loaded&&this._removeInternalLayers();this.name=a.name;this.description=a.description;this.snippet=a.snippet;this.visibility=a.visibility;this.featureInfos=a.featureInfos;var e,d,f=this.folders=a.folders,b=[],l;if(f){d=f.length;for(e=0;e<d;e++)l=f[e]=new t(f[e]),-1===l.parentFolderId&&b.push(l)}var f=this._links=a.networkLinks,c;d=f?f.length:0;for(e=0;e<d;e++)f[e].viewRefreshMode&&
-1!==f[e].viewRefreshMode.toLowerCase().indexOf("onregion")||(c=h.mixin({},this._options),c.linkInfo=f[e],c.id&&(c.id=c.id+"_"+e),f[e]=new y(f[e].href,c),f[e]._parentLayer=this,f[e]._parentFolderId=this._getLinkParentId(f[e].linkInfo.id));if((f=a.groundOverlays)&&0<f.length){c=h.mixin({},this._options);c.id&&(c.id+="_mapImage");l=this._groundLyr=new G(c);d=f.length;for(e=0;e<d;e++)l.addImage(new v(f[e]))}if((a=h.getObject("featureCollection.layers",!1,a))&&0<a.length)this._fLayers=[],r.forEach(a,
function(a,e){var d=h.getObject("featureSet.features",!1,a);d&&0<d.length&&(c=h.mixin({outFields:["*"],infoTemplate:a.popupInfo?new x(a.popupInfo):null,editable:!1},this._options),c.id&&(c.id=c.id+"_"+e),a.layerDefinition.capabilities="Query,Data",d=new H(a,c),d.geometryType&&(this["_"+d.geometryType]=d),this._fLayers.push(d))},this),0===this._fLayers.length&&delete this._fLayers;d=b.length;for(e=0;e<d;e++)l=b[e],this._setState(l,l.visible);this._fireUpdateEnd();this.loaded?(this._addInternalLayers(),
this.onRefresh()):(this.loaded=!0,this.onLoad(this))},_addInternalLayers:function(){var a=this._map;this._fireUpdateStart();this._links&&r.forEach(this._links,function(e){e.declaredClass&&(a.addLayer(e),e._waitingForMap&&(e._waitingForMap=null,e.visible?e._parseKml(a):e._wMap=a))});var e=a.spatialReference,f=this._outSR,b;if(!e.equals(f))if(e.isWebMercator()&&4326===f.wkid)b=d.geographicToWebMercator;else if(f.isWebMercator()&&4326===e.wkid)b=d.webMercatorToGeographic;else{console.log("KMLLayer:_setMap - unsupported workflow. Spatial reference of the map and kml layer do not match, and the conversion cannot be done on the client.");
return}this._groundLyr&&(b&&r.forEach(this._groundLyr.getImages(),function(a){a.extent=b(a.extent)}),a.addLayer(this._groundLyr));(e=this._fLayers)&&0<e.length&&r.forEach(e,function(e){if(b){var d=e.graphics,f,l,c=d?d.length:0;for(f=0;f<c;f++)(l=d[f].geometry)&&d[f].setGeometry(b(l))}a.addLayer(e)});this.onVisibilityChange(this.visible)},_removeInternalLayers:function(){var a=this._map;this._links&&r.forEach(this._links,function(a){a.declaredClass&&a._io&&a._io.cancel()});a&&r.forEach(this.getLayers(),
a.removeLayer,a)},_setState:function(a,e){var d=a.featureInfos,f,b,l,c=d?d.length:0,g=e?"show":"hide";for(l=0;l<c;l++)if(f=d[l],b=this.getFeature(f))if("Folder"===f.type)this._setState(b,e&&b.visible);else if("NetworkLink"===f.type)this._setInternalVisibility(b,e);else b[g]()},_areLocalAncestorsVisible:function(a){var e=a.parentFolderId;for(a=a.visible;a&&-1!==e;)e=this.getFeature({type:"Folder",id:e}),a=a&&e.visible,e=e.parentFolderId;return a},_setInternalVisibility:function(a,e){var d=a._parentLayer,
f=a._parentFolderId;for(e=e&&a.visible;e&&d;)e=e&&d.visible,-1<f&&(e=e&&d._areLocalAncestorsVisible(d.getFeature({type:"Folder",id:f}))),f=d._parentFolderId,d=d._parentLayer;this._setIntState(a,e)},_setIntState:function(a,e){a&&r.forEach(a.getLayers(),function(d){d.linkInfo?a._setIntState(d,e&&d.visible&&a._areLocalAncestorsVisible(a.getFeature({type:"Folder",id:d._parentFolderId}))):d.setVisibility(e)})},_getLinkParentId:function(a){var e=-1;this.folders&&r.some(this.folders,function(d){return d.networkLinkIds&&
-1!==r.indexOf(d.networkLinkIds,a)?(e=d.id,!0):!1});return e},_checkAutoRefresh:function(){var a=this.linkInfo;if(a)if(this.visible){if(this.loaded&&this._map){var e=a.refreshMode,d=a.refreshInterval,f=a.viewRefreshMode,a=a.viewRefreshTime;e&&(-1!==e.toLowerCase().indexOf("oninterval")&&0<d)&&(this._stopAutoRefresh(),this._timeoutHandle=setTimeout(this.refresh,1E3*d));f&&(-1!==f.toLowerCase().indexOf("onstop")&&0<a)&&!this._extChgHandle&&(this._extChgHandle=q.connect(this._map,"onExtentChange",this,
this._extentChanged))}}else this._stopAutoRefresh(),q.disconnect(this._extChgHandle),delete this._extChgHandle},_stopAutoRefresh:function(){clearTimeout(this._timeoutHandle);this._timeoutHandle=null},_getQueryParameters:function(a){a=a||this._map;var e={},f=this.linkInfo,b=a&&a.extent,c;this._url.query&&(h.mixin(e,this._url.query),c=!!this._url.query.token);if(l.id&&!c&&(c=l.id.findCredential(this._url.path)))e.token=c.token;if(f){c=f.viewFormat;var g=f.httpQuery,f=f.viewBoundScale;if(b&&c){var m=
b,p=b,q=b.spatialReference;q&&(q.isWebMercator()?m=d.webMercatorToGeographic(b):4326===q.wkid&&(p=d.geographicToWebMercator(b)));b=m.getCenter();p=Math.max(p.getWidth(),p.getHeight());f&&(m=m.expand(f));c=c.replace(/\[bboxWest\]/ig,m.xmin).replace(/\[bboxEast\]/ig,m.xmax).replace(/\[bboxSouth\]/ig,m.ymin).replace(/\[bboxNorth\]/ig,m.ymax).replace(/\[lookatLon\]/ig,b.x).replace(/\[lookatLat\]/ig,b.y).replace(/\[lookatRange\]/ig,p).replace(/\[lookatTilt\]/ig,0).replace(/\[lookatHeading\]/ig,0).replace(/\[lookatTerrainLon\]/ig,
b.x).replace(/\[lookatTerrainLat\]/ig,b.y).replace(/\[lookatTerrainAlt\]/ig,0).replace(/\[cameraLon\]/ig,b.x).replace(/\[cameraLat\]/ig,b.y).replace(/\[cameraAlt\]/ig,p).replace(/\[horizFov\]/ig,60).replace(/\[vertFov\]/ig,60).replace(/\[horizPixels\]/ig,a.width).replace(/\[vertPixels\]/ig,a.height).replace(/\[terrainEnabled\]/ig,0);h.mixin(e,n.queryToObject(c))}g&&(g=g.replace(/\[clientVersion\]/ig,l.version).replace(/\[kmlVersion\]/ig,2.2).replace(/\[clientName\]/ig,"ArcGIS API for JavaScript").replace(/\[language\]/ig,
k.locale),h.mixin(e,n.queryToObject(g)))}a=[];for(var t in e)s.isDefined(e[t])&&a.push(t+"\x3d"+e[t]);return(a=a.join("\x26"))?"?"+a:""},_setMap:function(a,e){this.inherited(arguments);this._map=a;var d=this._div=b.create("div",null,e);m.set(d,"position","absolute");this._addInternalLayers();this.evaluateSuspension();return d},_unsetMap:function(a,e){this._io&&this._io.cancel();this._stopAutoRefresh();q.disconnect(this._extChgHandle);delete this._extChgHandle;this._removeInternalLayers();var d=this._div;
d&&(e.removeChild(d),b.destroy(d));this._wMap=this._div=null;this.inherited(arguments)},onVisibilityChange:function(a){this.loaded?(this._fireUpdateStart(),this._setInternalVisibility(this,a),this._checkAutoRefresh(),this._fireUpdateEnd()):this.linkInfo&&a&&(this._waitingForMap||this._parseKml(this._wMap))},refresh:function(){this.loaded&&(this._map&&!this._io&&this.visible)&&this._parseKml()},_extentChanged:function(){this._stopAutoRefresh();this._timeoutHandle=setTimeout(this.refresh,1E3*this.linkInfo.viewRefreshTime)}});
g("extend-esri")&&h.setObject("layers.KMLLayer",y,l);return y})},"dojo/data/util/sorter":function(){define(["../../_base/lang"],function(k){var c={};k.setObject("dojo.data.util.sorter",c);c.basicComparator=function(c,h){var k=-1;null===c&&(c=void 0);null===h&&(h=void 0);if(c==h)k=0;else if(c>h||null==c)k=1;return k};c.createSortFunction=function(k,h){function r(a,e,f,d){return function(b,c){var l=d.getValue(b,a),g=d.getValue(c,a);return e*f(l,g)}}for(var p=[],g,n=h.comparatorMap,b=c.basicComparator,
m=0;m<k.length;m++){g=k[m];var l=g.attribute;if(l){g=g.descending?-1:1;var a=b;n&&("string"!==typeof l&&"toString"in l&&(l=l.toString()),a=n[l]||b);p.push(r(l,g,a,h))}}return function(a,e){for(var f=0;f<p.length;){var d=p[f++](a,e);if(0!==d)return d}return 0}};return c})},"esri/layers/OnDemandMode":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/has esri/kernel esri/geometry/Point esri/tasks/query esri/layers/RenderMode esri/layers/GridLayout".split(" "),
function(k,c,q,h,r,p,g,n,b,m){k=k([b],{declaredClass:"esri.layers._OnDemandMode",constructor:function(b){this.featureLayer=b;this._featureMap={};this._queryErrorHandler=q.hitch(this,this._queryErrorHandler)},initialize:function(b){this.inherited(arguments);var a=this.featureLayer,c=a._srInfo;this._gridLayer=new m(new g(c?c.valid[0]:b.extent.xmin,b.extent.ymax,b.spatialReference),{width:a._tileWidth,height:a._tileHeight},{width:b.width,height:b.height},c);this._cellMap={};this._gridLayer.setResolution(b.extent)},
startup:function(){this._ioQueue=[];this.featureLayer.suspended||(this._zoomHandler(),this._enableConnectors())},propertyChangeHandler:function(b){this._init&&(2>b?this._zoomHandler():console.log("FeatureLayer: layer in on-demand mode does not support time definitions. Layer id \x3d "+this.featureLayer.id+", Layer URL \x3d "+this.featureLayer.url))},destroy:function(){this._disableConnectors();this.inherited(arguments)},drawFeature:function(b){var a=this._gridLayer,c=b.geometry,e=[];if(c)for(var e=
a.getCellsInExtent("point"===c.type?{xmin:c.x,ymin:c.y,xmax:c.x,ymax:c.y}:c.getExtent(),!1).cells,a=this._cellMap,f,d=b.attributes[this.featureLayer.objectIdField],g,m,n,c=0;c<e.length;c++)f=e[c],g=f.latticeID,m=f.row,n=f.col,g?f=a[g]=a[g]||f:(a[m]=a[m]||{},f=a[m][n]=a[m][n]||f),f.features=f.features||[],f.features.push(b),this._addFeatureIIf(d,b),this._incRefCount(d)},suspend:function(){this._init&&this._disableConnectors()},resume:function(){this._init&&(this._enableConnectors(),this._zoomHandler())},
refresh:function(){this._zoomHandler()},_enableConnectors:function(){var b=this.map;this._zoomConnect=c.connect(b,"onZoomEnd",this,this._zoomHandler);this._panConnect=c.connect(b,"onPanEnd",this,this._panHandler);this._resizeConnect=c.connect(b,"onResize",this,this._panHandler)},_disableConnectors:function(){c.disconnect(this._zoomConnect);c.disconnect(this._panConnect);c.disconnect(this._resizeConnect)},_zoomHandler:function(){this._processIOQueue(!0);var b=this.featureLayer,a=this.map;b.suspended||
(b._fireUpdateStart(),this._clearIIf(),(b=b._trackManager)&&b.clearTracks(),this._cellMap={},this._gridLayer.setResolution(a.extent),this._sendRequest())},_panHandler:function(b){this.featureLayer._fireUpdateStart();this._sendRequest(this.featureLayer._resized&&b)},_getRequestId:function(b,a){return("_"+b.name+b.layerId+b._ulid+"_"+a.resolution+"_"+(a.latticeID||a.row+"_"+a.col)).replace(/[^a-zA-Z0-9\_]+/g,"_")},_sendRequest:function(b){this._exceeds=!1;var a=this.featureLayer,c=this.map;b=b||c.extent;
c=this._gridLayer.getCellsInExtent(b,a.latticeTiling).cells;if(!a.isEditable())var e=this._cellMap,c=h.filter(c,function(a){if(a.lattice){if(e[a.latticeID])return!1}else if(e[a.row]&&e[a.row][a.col])return!1;return!0});var f=a.getOutFields(),d=a.getDefinitionExpression(),g=a._getOffsettedTE(a._mapTimeExtent),m=a.supportsAdvancedQueries?a.getOrderByFields():null,p=a._usePatch,k=this._ioQueue,q,r=this,y=this._drawFeatures,u,z,D;this._pending=this._pending||0;for(q=0;q<c.length;q++){u=c[q];z=new n;z.geometry=
u.extent||u.lattice;z.outFields=f;z.where=d;a.latticeTiling&&u.extent&&(z.spatialRelationship=n.SPATIAL_REL_CONTAINS);z.returnGeometry=!0;z.timeExtent=g;z.maxAllowableOffset=a._maxOffset;a._ts&&(z._ts=(new Date).getTime());z.orderByFields=m;D=null;if(p&&(D=this._getRequestId(a,u),this._isPending(D)))continue;this._pending++;k.push(a._task.execute(z,function(){var a=u;return function(e){y.apply(r,[e,a])}}.call(this),this._queryErrorHandler,D))}this._removeOldCells(b);this._endCheck()},_drawFeatures:function(b,
a){this._exceeds=this._exceeds||b.exceededTransferLimit;this._finalizeIO();var c=this.map.extent,e=a.extent,f=a.row,d=a.col,g=this.featureLayer.objectIdField,m=b.features,n=this._gridLayer,h=this._cellMap,p=a.latticeID,k=p?h[p]:h[f]&&h[f][d];if(a.resolution!=n._resolution||(p?p!==n.getLatticeID(c):!n.intersects(e,c)))k&&this._removeCell(f,d,p);else if(k)this._updateCell(k,m);else{a.features=m;p?h[p]=a:(h[f]=h[f]||{},h[f][d]=a);e=m.length;for(c=0;c<e;c++)f=m[c],d=f.attributes[g],this._addFeatureIIf(d,
f),this._incRefCount(d)}this._endCheck()},_queryErrorHandler:function(b){this._finalizeIO();this.featureLayer._errorHandler(b);this._endCheck(!0)},_finalizeIO:function(){this._purgeRequests();this._pending--},_endCheck:function(b){if(0===this._pending){this._processIOQueue();var a=this.featureLayer,c=a._trackManager;c&&(c.clearTracks(),c.addFeatures(a.graphics),a._ager&&h.forEach(a.graphics,function(e){e._shape&&a._repaint(e)}),c.moveLatestToFront(),c.drawTracks());this.featureLayer._fireUpdateEnd(b&&
Error("FeatureLayer: an error occurred while updating the layer"),this._exceeds?{queryLimitExceeded:!0}:null);if(this._exceeds)a.onQueryLimitExceeded()}},_processIOQueue:function(b){this._ioQueue=h.filter(this._ioQueue,function(a){return-1<a.fired?!1:!0});b&&h.forEach(this._ioQueue,this._cancelPendingRequest)},_removeOldCells:function(b){var a=this._cellMap,c=this._gridLayer,e,f;for(e in a)if(a[e]){var d=a[e],g=d.latticeID,m=0,n=0;if(g)m++,g!==c.getLatticeID(b)&&(this._removeCell(null,null,g),n++);
else for(f in d)d[f]&&(m++,c.intersects(d[f].extent,b)||(this._removeCell(e,f),n++));n===m&&delete a[e]}},_updateCell:function(b,a){var c=this.featureLayer,e=c.objectIdField,c=c._selectedFeatures,f,d=a.length;b.features=b.features||[];for(f=0;f<d;f++){var g=a[f],m=g.attributes[e],n=this._addFeatureIIf(m,g);n===g?(this._incRefCount(m),b.features.push(n)):m in c||(n.setGeometry(g.geometry),n.setAttributes(g.attributes))}},_removeCell:function(b,a,c){var e=this._cellMap,f=this.featureLayer,d=f.objectIdField,
g=c?e[c]:e[b]&&e[b][a];if(g){c?delete e[c]:delete e[b][a];b=g.features;for(a=0;a<b.length;a++)c=b[a].attributes[d],this._decRefCount(c),c in f._selectedFeatures||this._removeFeatureIIf(c)}}});r("extend-esri")&&q.setObject("layers._OnDemandMode",k,p);return k})},"esri/layers/FeatureLayer":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/date/locale dojo/sniff dojo/io-query dojo/dom-construct dojo/i18n esri/kernel esri/lang esri/request esri/deferredUtils esri/SpatialReference esri/symbols/SimpleMarkerSymbol esri/symbols/SimpleLineSymbol esri/symbols/SimpleFillSymbol esri/symbols/jsonUtils esri/renderers/SimpleRenderer esri/renderers/UniqueValueRenderer esri/renderers/jsonUtils esri/tasks/QueryTask esri/tasks/query esri/tasks/FeatureSet esri/geometry/Extent esri/geometry/jsonUtils esri/geometry/normalizeUtils esri/layers/GraphicsLayer esri/layers/Field esri/layers/TimeInfo esri/layers/FeatureType esri/layers/FeatureTemplate esri/layers/FeatureEditResult esri/layers/LabelClass esri/layers/SnapshotMode esri/layers/OnDemandMode esri/layers/SelectionMode esri/layers/TrackManager dojo/i18n!esri/nls/jsapi dojo/has!extend-esri?esri/layers/agscommon".split(" "),
function(k,c,q,h,r,p,g,n,b,m,l,a,s,e,f,d,x,B,t,v,G,H,y,u,z,D,F,N,Z,O,$,J,aa,ba,M,P,R,ca,da,ea){k=k(O,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",_eventMap:{"add-attachment-complete":["result"],"before-apply-edits":["adds","updates","deletes"],"delete-attachments-complete":["results"],"edits-complete":["adds","updates","deletes"],"query-attachment-infos-complete":["results"],"query-count-complete":["count"],"query-features-complete":["featureSet"],
"query-ids-complete":["objectIds"],"query-related-features-complete":["featureSets"],"selection-complete":["features","method"],"update-end":["error","info"]},constructor:function(a,d){this.i18n=l.getLocalization("esri","jsapi");d=d||{};this._outFields=d.outFields;this._loadCallback=d.loadCallback;var b=d._usePatch;this._usePatch=null===b||void 0===b?!0:b;this._trackIdField=d.trackIdField;this.objectIdField=d.objectIdField;this._maxOffset=d.maxAllowableOffset;this._optEditable=d.editable;this._optAutoGen=
d.autoGeneralize;this.editSummaryCallback=d.editSummaryCallback;this.userId=d.userId;this.userIsAdmin=d.userIsAdmin;this.useMapTime=d.hasOwnProperty("useMapTime")?!!d.useMapTime:!0;this.source=d.source;this.gdbVersion=d.gdbVersion;this.orderByFields=d.orderByFields;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();b=this.constructor;switch(this.mode=s.isDefined(d.mode)?d.mode:b.MODE_ONDEMAND){case b.MODE_SNAPSHOT:this._mode=
new R(this);this._isSnapshot=!0;break;case b.MODE_ONDEMAND:this._tileWidth=d.tileWidth||512;this._tileHeight=d.tileHeight||512;this._mode=new ca(this);this.latticeTiling=d.latticeTiling;break;case b.MODE_SELECTION:this._mode=new da(this),this._isSelOnly=!0}this._initLayer=q.hitch(this,this._initLayer);this._selectHandler=q.hitch(this,this._selectHandler);this._editable=!1;if(q.isObject(a)&&a.layerDefinition)return this._collection=!0,this.mode=b.MODE_SNAPSHOT,this._initLayer(a),this;this._task=new u(this.url,
{source:this.source,gdbVersion:this.gdbVersion});b=this._url.path;this._fserver=!1;-1!==b.search(/\/FeatureServer\//i)&&(this._fserver=!0);var f=d.resourceInfo;f?this._initLayer(f):(this.source&&(f={source:this.source.toJson()},this._url.query=q.mixin(this._url.query,{layer:r.toJson(f)})),this.gdbVersion&&(this._url.query=q.mixin(this._url.query,{gdbVersion:this.gdbVersion})),e({url:b,content:q.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}));
this.registerConnectEvents()},_initLayer:function(a,e){if(a||e){this._json=a;this._findCredential();if(this.credential&&this.credential.ssl||a&&a._ssl)this._useSSL(),this._task._useSSL();this._collection&&(this._mode=new R(this),this._isSnapshot=!0,this._featureSet=a.featureSet,this._nextId=a.nextObjectId,a=a.layerDefinition);if(a.hasOwnProperty("capabilities")){var b=this.capabilities=a.capabilities;b&&-1!==b.toLowerCase().indexOf("editing")?this._editable=!0:this._editable=!1}else this._collection||
(this._editable=this._fserver);s.isDefined(this._optEditable)&&(this._editable=this._optEditable,delete this._optEditable);this._json=r.toJson(this._json);if(this.isEditable())delete this._maxOffset;else if(this.mode!==this.constructor.MODE_SNAPSHOT&&("esriGeometryPolyline"===a.geometryType||"esriGeometryPolygon"===a.geometryType))this._autoGeneralize=s.isDefined(this._optAutoGen)?this._optAutoGen:this.mode===this.constructor.MODE_ONDEMAND,delete this._optAutoGen;var b=a.effectiveMinScale||a.minScale,
f=a.effectiveMaxScale||a.maxScale;!this._hasMin&&b&&this.setMinScale(b);!this._hasMax&&f&&this.setMaxScale(f);this.layerId=a.id;this.name=a.name;this.description=a.description;this.copyright=a.copyrightText;this.type=a.type;this.geometryType=a.geometryType;this.displayField=a.displayField;this.defaultDefinitionExpression=a.definitionExpression;this.fullExtent=new F(a.extent);this.initialExtent=new F(this.fullExtent.toJson());this.fullExtent.spatialReference&&(this.spatialReference=new d(this.fullExtent.spatialReference.toJson()));
this.defaultVisibility=a.defaultVisibility;if("esriGeometryPoint"===this.geometryType||"esriGeometryMultipoint"===this.geometryType)this.latticeTiling=!1;this.indexedFields=a.indexedFields;this.maxRecordCount=a.maxRecordCount;this.canModifyLayer=a.canModifyLayer;this.supportsStatistics=a.supportsStatistics;this.supportsAdvancedQueries=this._collection?!1:a.supportsAdvancedQueries;this.hasLabels=a.hasLabels;this.canScaleSymbols=a.canScaleSymbols;this.supportsRollbackOnFailure=a.supportsRollbackOnFailure;
this.syncCanReturnChanges=a.syncCanReturnChanges;this.isDataVersioned=a.isDataVersioned;this.editFieldsInfo=a.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=a.ownershipBasedAccessControlForFeatures;this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures&&(this.creatorField=this.editFieldsInfo.creatorField);this.relationships=a.relationships;this.allowGeometryUpdates=s.isDefined(a.allowGeometryUpdates)?a.allowGeometryUpdates:!0;this._isTable="Table"===this.type;for(var c=this.fields=
[],f=a.fields,b=0;b<f.length;b++)c.push(new $(f[b]));if(!this.objectIdField){this.objectIdField=a.objectIdField;if(!this.objectIdField){f=a.fields;for(b=0;b<f.length;b++)if(c=f[b],"esriFieldTypeOID"===c.type){this.objectIdField=c.name;break}}this.objectIdField||console.debug("esri.layers.FeatureLayer: "+s.substitute({url:this.url},"objectIdField is not set [url: ${url}]"))}if(!s.isDefined(this._nextId)){f=this.objectIdField;c=-1;if(this._collection&&f)for(var g=(b=this._featureSet)&&b.features,m=
g?g.length:0,l,b=0;b<m;b++)l=(l=g[b].attributes)&&l[f],l>c&&(c=l);this._nextId=c+1}this.globalIdField=a.globalIdField;if(b=this.typeIdField=a.typeIdField)if(b=!this._getField(b)&&this._getField(b,!0))this.typeIdField=b.name;this.visibilityField=a.visibilityField;if(f=a.defaultSymbol)this.defaultSymbol=v.fromJson(f);var p=this.types=[],k=a.types,u,z,c=(b=this.editFieldsInfo)&&b.creatorField,g=b&&b.editorField;l=c||g;m=[];if(k)for(b=0;b<k.length;b++)u=new aa(k[b]),z=u.templates,l&&(z&&z.length)&&(m=
m.concat(z)),p.push(u);k=a.templates;u=this.templates=[];if(k)for(b=0;b<k.length;b++)p=new ba(k[b]),l&&m.push(p),u.push(p);for(b=0;b<m.length;b++)if(l=q.getObject("prototype.attributes",!1,m[b]))c&&delete l[c],g&&delete l[g];if(b=a.timeInfo)this.timeInfo=new J(b),this._startTimeField=b.startTimeField,this._endTimeField=b.endTimeField,this._startTimeField&&this._endTimeField&&(this._twoTimeFields=!0),this._trackIdField?b.trackIdField=this._trackIdField:this._trackIdField=b.trackIdField;this.hasAttachments=
!this._collection&&a.hasAttachments?!0:!1;this.htmlPopupType=a.htmlPopupType;var b=a.drawingInfo,A;if(c=b&&b.labelingInfo)this.labelingInfo=h.map(c,function(a){return new P(a)});if(!this.renderer)if(b&&b.renderer){if(A=b.renderer,this.setRenderer(y.fromJson(A)),"classBreaks"===A.type&&this.renderer.setMaxInclusive(!0),!this._collection){var E=A.type,f=[];A=this.renderer;switch(E){case "simple":f.push(A.symbol);break;case "uniqueValue":case "classBreaks":f.push(A.defaultSymbol),f=f.concat(h.map(A.infos,
function(a){return a.symbol}))}var f=h.filter(f,s.isDefined),N=this._url.path+"/images/",O=this._getToken();h.forEach(f,function(a){var e=a.url;e&&(-1===e.search(/https?\:/)&&-1===e.indexOf("data:")&&(a.url=N+e),O&&-1!==a.url.search(/https?\:/)&&(a.url+="?token\x3d"+O))})}}else if(f)k=this.types,0<k.length?(A=new H(this.defaultSymbol,this.typeIdField),h.forEach(k,function(a){A.addValue(a.id,a.symbol)})):A=new G(this.defaultSymbol),this.setRenderer(A);else if(!this._isTable){switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":E=
new x;break;case "esriGeometryPolyline":E=new B;break;case "esriGeometryPolygon":E=new t}this.setRenderer(E?new G(E):null)}E=b&&b.transparency||0;!s.isDefined(this.opacity)&&0<E&&(this.opacity=1-E/100);this.version=a.currentVersion;this.version||(this.version="capabilities"in a||"drawingInfo"in a||"hasAttachments"in a||"htmlPopupType"in a||"relationships"in a||"timeInfo"in a||"typeIdField"in a||"types"in a?10:9.3);if((n("ie")||n("safari"))&&this.isEditable()&&10.02>this.version)this._ts=!0;this.loaded=
!0;this._fixRendererFields();this._checkFields();this._updateCaps();E=function(){this.onLoad(this);var a=this._loadCallback;a&&(delete this._loadCallback,a(this))};this._collection?(this._fireUpdateStart(),b=this._featureSet,delete this._featureSet,this._mode._drawFeatures(new D(b)),this._fcAdded=!0,E.call(this)):this._forceIdentity(E)}},onRendererChange:function(){this.inherited(arguments);var a=this._getRenderer();this._ager=!(!a||!a.observationAger||!a.observationRenderer);if(a){var e=[],a=h.filter([a,
a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],s.isDefined);h.forEach(a,function(a){q.isFunction(a.attributeField)||e.push(a.attributeField);e.push(a.attributeField2);e.push(a.attributeField3)},this);this._rendererFields=h.filter(e,s.isDefined)}else this._rendererFields=[];this.loaded&&(this._fixRendererFields(),this._checkFields(this._rendererFields),this._collection&&(this._typesDirty=!0))},redraw:function(){this.inherited(arguments);this._trackManager&&this._trackManager.container&&
this._trackManager.container.redraw()},_evalSDRenderer:function(){this.inherited(arguments);var a=this._getRenderer();this._ager=!(!a||!a.observationAger||!a.observationRenderer);this._trackManager&&this._trackManager.container&&this._trackManager.container.setRenderer(a&&a.trackRenderer)},_setMap:function(a){var e=this.inherited(arguments),b=this._mode,d=this;b&&b.initialize(a);this.geometryType&&this.attr("data-geometry-type",this.geometryType.replace(/esriGeometry/i,"").toLowerCase());this._addHandle=
this.on("graphic-node-add",function(a){a=a.graphic.attributes;(a=d._selectedFeatures[a&&a[d.objectIdField]])&&a.attr("data-selected","")});return e},_unsetMap:function(a){var e=this._mode;e&&e.suspend();this._trackManager&&(this._trackManager.destroy(),this._trackManager=null);c.disconnect(this._zoomConnect);c.disconnect(this._addHandle);this._zoomConnect=this._addHandle=null;this._toggleTime(!1);this.inherited("_unsetMap",arguments)},refresh:function(){var a=this._mode;a&&a.refresh()},getOutFields:function(){return h.filter(this._getOutFields(),
function(a){return"*"===a||!!this._getField(a)},this)},setEditable:function(a){if(!this._collection)return console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service"),this;if(!this.loaded)return this._optEditable=a,this;var e=this._editable;this._editable=a;this._updateCaps();if(e!==a)this.onCapabilitiesChange();return this},getEditCapabilities:function(a){var e={canCreate:!1,canUpdate:!1,canDelete:!1};if(!this.loaded||!this.isEditable())return e;
var b=a&&a.feature;a=a&&a.userId;var d=h.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],q.trim),f=-1<h.indexOf(d,"editing"),c=f&&-1<h.indexOf(d,"create"),e=f&&-1<h.indexOf(d,"update"),d=f&&-1<h.indexOf(d,"delete"),g=this.ownershipBasedAccessControlForFeatures,m=this.editFieldsInfo,l=m&&m.creatorField,m=m&&m.realm,b=(b=b&&b.attributes)&&l?b[l]:void 0,n=!!this.userIsAdmin,l=!g||n||!(!g.allowOthersToUpdate&&!g.allowUpdateToOthers),g=!g||n||!(!g.allowOthersToDelete&&!g.allowDeleteToOthers);
if(n||f&&!c&&!e&&!d)c=e=d=!0;f={canCreate:c,canUpdate:e,canDelete:d};null===b?(f.canUpdate=e&&l,f.canDelete=d&&g):""!==b&&b&&((a=a||this.getUserId())&&m&&(a=a+"@"+m),a.toLowerCase()!==b.toLowerCase()&&(f.canUpdate=e&&l,f.canDelete=d&&g));return f},getUserId:function(){var a;this.loaded&&(a=this.credential&&this.credential.userId||this.userId||"");return a},setUserIsAdmin:function(a){this.userIsAdmin=a},setEditSummaryCallback:function(a){this.editSummaryCallback=a},getEditSummary:function(a,e,b){b=
s.isDefined(b)?b:(new Date).getTime();var d="";b=this.getEditInfo(a,e,b);(e=e&&e.callback||this.editSummaryCallback)&&(b=e(a,b)||"");if(q.isString(b))d=b;else{if(b){a=b.action;e=b.userId;var f=b.timeValue,c=0;a&&c++;e&&c++;s.isDefined(f)&&c++;1<c&&(d=("edit"===a?"edit":"create")+(e?"User":"")+(s.isDefined(f)?b.displayPattern:""))}d=d&&s.substitute(b,this.i18n.layers.FeatureLayer[d])}return d},getEditInfo:function(a,e,b){if(this.loaded){b=s.isDefined(b)?b:(new Date).getTime();e=e&&e.action||"last";
var d=this.editFieldsInfo,f=d&&d.creatorField,c=d&&d.creationDateField,g=d&&d.editorField,d=d&&d.editDateField,g=(a=a&&a.attributes)&&g?a[g]:void 0,d=a&&d?a[d]:null,f=this._getEditData(a&&f?a[f]:void 0,a&&c?a[c]:null,b);b=this._getEditData(g,d,b);var m;switch(e){case "creation":m=f;break;case "edit":m=b;break;case "last":m=b||f}m&&(m.action=m===b?"edit":"creation");return m}},_getEditData:function(a,e,b){var d,f,c;s.isDefined(e)&&(f=b-e,c=0>f?"Full":6E4>f?"Seconds":12E4>f?"Minute":36E5>f?"Minutes":
72E5>f?"Hour":864E5>f?"Hours":6048E5>f?"WeekDay":"Full");if(void 0!==a||c)d=d||{},d.userId=a,c&&(a=g.format,b=new Date(e),d.minutes=Math.floor(f/6E4),d.hours=Math.floor(f/36E5),d.weekDay=a(b,{datePattern:"EEEE",selector:"date"}),d.formattedDate=a(b,{selector:"date"}),d.formattedTime=a(b,{selector:"time"}),d.displayPattern=c,d.timeValue=e);return d},isEditable:function(){return!(!this._editable&&!this.userIsAdmin)},setMaxAllowableOffset:function(a){this.isEditable()||(this._maxOffset=a);return this},
getMaxAllowableOffset:function(){return this._maxOffset},setAutoGeneralize:function(a){if(this.loaded){if(!this.isEditable()&&this.mode!==this.constructor.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType))if(this._autoGeneralize=a){if((a=this._map)&&a.loaded)this._maxOffset=Math.floor(a.extent.getWidth()/a.width)}else delete this._maxOffset}else this._optAutoGen=a;return this},setGDBVersion:function(a){if(!this._collection&&a!==this.gdbVersion&&
(a||this.gdbVersion))this.gdbVersion=a,this._task.gdbVersion=a,this._url.query=q.mixin(this._url.query,{gdbVersion:a}),this.loaded&&(this.clearSelection(),this._map&&this.refresh()),this.onGDBVersionChange();return this},setDefinitionExpression:function(a){this._defnExpr=a;(a=this._mode)&&a.propertyChangeHandler(1);return this},getDefinitionExpression:function(){return this._defnExpr},setTimeDefinition:function(a){this._isSnapshot?(this._timeDefn=a,(a=this._mode)&&a.propertyChangeHandler(2)):console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id \x3d "+
this.id+", Layer URL \x3d "+this.url);return this},getTimeDefinition:function(){return this._timeDefn},setTimeOffset:function(a,e){this._timeOffset=a;this._timeOffsetUnits=e;var b=this._mode;b&&b.propertyChangeHandler(0);return this},setUseMapTime:function(a){this.useMapTime=a;this._toggleTime(!this.suspended);(a=this._mode)&&a.propertyChangeHandler(0)},selectFeatures:function(a,e,b,c){e=e||this.constructor.SELECTION_NEW;a=this._getShallowClone(a);var g=this._map,m=f._fixDfd(new p(f._dfdCanceller));
a.outFields=this.getOutFields();a.returnGeometry=!0;g&&(a.outSpatialReference=new d(g.spatialReference.toJson()));if(!this._applyQueryFilters(a,!0))return a={features:[]},this._selectHandler(a,e,b,c,m),m;if(g=this._canDoClientSideQuery(a))a={features:this._doQuery(a,g)},this._selectHandler(a,e,b,c,m);else{if(this._collection)return this._resolve([Error("FeatureLayer::selectFeatures - "+this.invalidParams)],null,c,m,!0),m;var l=this;this._ts&&(a._ts=(new Date).getTime());(m._pendingDfd=this._task.execute(a)).addCallbacks(function(a){l._selectHandler(a,
e,b,c,m)},function(a){l._resolve([a],null,c,m,!0)})}return m},getSelectedFeatures:function(){var a=this._selectedFeatures,e=[],b;for(b in a)a.hasOwnProperty(b)&&e.push(a[b]);return e},clearSelection:function(a){var e=this._selectedFeatures,b=this._mode,d;for(d in e)e.hasOwnProperty(d)&&(this._unSelectFeatureIIf(d,b),b._removeFeatureIIf(d));this._selectedFeatures={};this._isSelOnly&&b._applyTimeFilter(!0);if(!a)this.onSelectionClear();return this},setSelectionSymbol:function(a){if(this._selectionSymbol=
a){var e=this._selectedFeatures,b;for(b in e)e.hasOwnProperty(b)&&e[b].setSymbol(a)}return this},getSelectionSymbol:function(){return this._selectionSymbol},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(a,b,d,f,c,g){var m=g.assembly,l=g.dfd;this._applyNormalized(a,m&&m[0]);this._applyNormalized(b,m&&m[1]);this.onBeforeApplyEdits(a,b,d);var n={},p=this.objectIdField,m={f:"json"},k=!1;if(this._collection)g={},g.addResults=a?h.map(a,function(){k=!0;return{objectId:this._nextId++,
success:!0}},this):null,g.updateResults=b?h.map(b,function(a){k=!0;var b=a.attributes[p];n[b]=a;return{objectId:b,success:!0}},this):null,g.deleteResults=d?h.map(d,function(a){k=!0;return{objectId:a.attributes[p],success:!0}},this):null,k&&this._editHandler(g,a,n,f,c,l);else{a&&0<a.length&&(m.adds=this._convertFeaturesToJson(a,0,1),k=!0);if(b&&0<b.length){for(g=0;g<b.length;g++){var s=b[g];n[s.attributes[p]]=s}m.updates=this._convertFeaturesToJson(b,0,0,1);k=!0}if(d&&0<d.length){b=[];for(g=0;g<d.length;g++)b.push(d[g].attributes[p]);
m.deletes=b.join(",");k=!0}if(k){var r=this;return e({url:this._url.path+"/applyEdits",content:q.mixin(m,this._url.query),callbackParamName:"callback",load:function(b){r._editHandler(b,a,n,f,c,l)},error:function(a){r._resolve([a],null,c,l,!0)}},{usePost:!0})}}},queryFeatures:function(a,b,e){return this._query("execute","onQueryFeaturesComplete",a,b,e)},queryRelatedFeatures:function(a,b,e){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",a,b,e)},queryIds:function(a,b,
e){return this._query("executeForIds","onQueryIdsComplete",a,b,e)},queryCount:function(a,b,e){return this._query("executeForCount","onQueryCountComplete",a,b,e)},queryAttachmentInfos:function(a,d,c){var g=this._url.path+"/"+a+"/attachments",m=new p(f._dfdCanceller),l=this;m._pendingDfd=e({url:g,content:q.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(e){e=e.attachmentInfos;var f;h.forEach(e,function(e){f=b.objectToQuery({gdbVersion:l._url.query&&l._url.query.gdbVersion,
layer:l._url.query&&l._url.query.layer,token:l._getToken()});e.url=g+"/"+e.id+(f?"?"+f:"");e.objectId=a});l._resolve([e],"onQueryAttachmentInfosComplete",d,m)},error:function(a){l._resolve([a],null,c,m,!0)}});return m},addAttachment:function(a,b,e,d){return this._sendAttachment("add",a,b,e,d)},updateAttachment:function(a,b,e,d,f){e.appendChild(m.create("input",{type:"hidden",name:"attachmentId",value:b}));return this._sendAttachment("update",a,e,d,f)},deleteAttachments:function(a,b,d,c){var g=this._url.path+
"/"+a+"/deleteAttachments",m=new p(f._dfdCanceller),l=this;b={f:"json",attachmentIds:b.join(",")};m._pendingDfd=e({url:g,content:q.mixin(b,this._url.query),callbackParamName:"callback",load:q.hitch(this,function(b){b=b.deleteAttachmentResults;b=h.map(b,function(b){b=new M(b);b.attachmentId=b.objectId;b.objectId=a;return b});l._resolve([b],"onDeleteAttachmentsComplete",d,m)}),error:function(a){l._resolve([a],null,c,m,!0)}},{usePost:!0});return m},addType:function(a){var b=this.types;if(b){if(h.some(b,
function(b){return b.id==a.id?!0:!1}))return!1;b.push(a)}else this.types=[a];return this._typesDirty=!0},deleteType:function(a){if(this._collection){var b=this.types;if(b){var e=-1;h.some(b,function(b,d){return b.id==a?(e=d,!0):!1});if(-1<e)return this._typesDirty=!0,b.splice(e,1)[0]}}},toJson:function(){var a=this._json;if(a=q.isString(a)?r.fromJson(a):q.clone(a)){var a=a.layerDefinition?a:{layerDefinition:a},b=a.layerDefinition,e=this._collection;if(e&&this._typesDirty){b.types=h.map(this.types||
[],function(a){return a.toJson()});var d=this.renderer,f=b.drawingInfo;d&&!f&&(f=b.drawingInfo={});f&&(d&&-1===d.declaredClass.indexOf("TemporalRenderer"))&&(f.renderer=d.toJson())}d=null;if(!e||this._fcAdded)d={geometryType:b.geometryType,features:this._convertFeaturesToJson(this.graphics,!0)};a.featureSet=q.mixin({},a.featureSet||{},d);e&&(a.nextObjectId=this._nextId,b.capabilities=this.capabilities);return a}},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},
onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},_forceIdentity:function(b){var e=this,d=this._url&&this._url.path;
(this.ownershipBasedAccessControlForFeatures||this.userIsAdmin)&&!this._getToken()&&d&&a.id&&a.id._hasPortalSession()&&a.id._doPortalSignIn(d)?a.id.getCredential(d).then(function(){e._findCredential();b.call(e)},function(){b.call(e)}):b.call(this)},_updateCaps:function(){var a=this._editable,b=q.trim(this.capabilities||""),e=h.map(b?b.split(","):[],q.trim),d=h.map(b?b.toLowerCase().split(","):[],q.trim),b=h.indexOf(d,"editing"),f,d={Create:h.indexOf(d,"create"),Update:h.indexOf(d,"update"),Delete:h.indexOf(d,
"delete")};if(a&&-1===b)e.push("Editing");else if(!a&&-1<b){a=[b];for(f in d)-1<d[f]&&a.push(d[f]);a.sort();for(f=a.length-1;0<=f;f--)e.splice(a[f],1)}this.capabilities=e.join(",")},_counter:{value:0},_getUniqueId:function(){return this._counter.value++},onSuspend:function(){this.inherited(arguments);this._toggleTime(!1);var a=this._mode;a&&a.suspend()},onResume:function(a){this.inherited(arguments);this._toggleTime(!0);this._updateMaxOffset();var b=this._mode,e=this._map,d=this._getRenderer();if(a.firstOccurrence){this._fixRendererFields();
this._checkFields();this.clearSelection();if(this.timeInfo&&(this._trackIdField||d&&(d.latestObservationRenderer||d.trackRenderer)))this._trackManager=new ea(this),this._trackManager.initialize(e);this._zoomConnect=c.connect(e,"onZoomEnd",this,this._updateMaxOffset)}b&&(a.firstOccurrence?b.startup():b.resume())},_updateMaxOffset:function(){var a=this._map;a&&a.loaded&&this._autoGeneralize&&(this._maxOffset=Math.floor(a.extent.getWidth()/a.width))},_toggleTime:function(a){var b=this._map;a&&this.timeInfo&&
this.useMapTime&&b?(this._mapTimeExtent=b.timeExtent,this._timeConnect||(this._timeConnect=c.connect(b,"onTimeExtentChange",this,this._timeChangeHandler))):(this._mapTimeExtent=null,c.disconnect(this._timeConnect),this._timeConnect=null)},_timeChangeHandler:function(a){this._mapTimeExtent=a;(a=this._mode)&&a.propertyChangeHandler(0)},_getOffsettedTE:function(a){var b=this._timeOffset,e=this._timeOffsetUnits;return a&&b&&e?a.offset(-1*b,e):a},_getTimeOverlap:function(a,b){return a&&b?a.intersection(b):
a||b},_getTimeFilter:function(a){var b=this.getTimeDefinition(),e;if(b&&(e=this._getTimeOverlap(b,null),!e))return[!1];if(a){if(a=e?this._getTimeOverlap(a,e):a,!a)return[!1]}else a=e;return[!0,a]},_getAttributeFilter:function(a){var b=this.getDefinitionExpression();return a?b?"("+b+") AND ("+a+")":a:b},_applyQueryFilters:function(a,b){a.where=this._getAttributeFilter(a.where);a.maxAllowableOffset=this._maxOffset;b&&this.supportsAdvancedQueries&&(a.orderByFields=a.orderByFields||this.getOrderByFields());
if(this.timeInfo){var e=this._getTimeFilter(a.timeExtent);if(e[0])a.timeExtent=e[1];else return!1}return!0},_add:function(a){var b=this._selectionSymbol,e=a.attributes,d=this.visibilityField;b&&this._isSelOnly&&a.setSymbol(b);if(d&&e&&e.hasOwnProperty(d))a[e[d]?"show":"hide"]();return this.add.apply(this,arguments)},_remove:function(){return this.remove.apply(this,arguments)},_canDoClientSideQuery:function(a){var b=[],e=this._map;if(!this._isTable&&e&&!a.text&&!(a.where&&a.where!==this.getDefinitionExpression()||
a.orderByFields&&a.orderByFields.length)){var d=this._isSnapshot,f=this._isSelOnly,c=a.geometry;if(c)if(!f&&a.spatialRelationship===z.SPATIAL_REL_INTERSECTS&&"extent"===c.type&&(d||e.extent.contains(c)))b.push(1);else return;if(e=a.objectIds)if(d)b.push(2);else{var c=e.length,g=this._mode,m=0,l;for(l=0;l<c;l++)g._getFeature(e[l])&&m++;if(m===c)b.push(2);else return}if(this.timeInfo)if(a=a.timeExtent,e=this._mapTimeExtent,d)a&&b.push(3);else if(f){if(a)return}else if(e)if(-1!==h.indexOf(b,2))a&&b.push(3);
else return;else if(0<b.length)a&&b.push(3);else if(a)return;return 0<b.length?b:null}},_doQuery:function(a,b,e){var d=[],f=this._mode,c=this.objectIdField,g,m;if(-1!==h.indexOf(b,2)){var d=[],l=a.objectIds;m=l.length;for(g=0;g<m;g++){var n=f._getFeature(l[g]);n&&d.push(n)}if(0===d.length)return[]}if(-1!==h.indexOf(b,1)){f=0<d.length?d:this.graphics;m=f.length;l=a.geometry._normalize(null,!0);d=[];for(g=0;g<m;g++){var n=f[g],k=n.geometry;k&&(this.normalization&&l.length?(l[0].intersects(k)||l[1].intersects(k))&&
d.push(n):l.intersects(k)&&d.push(n))}if(0===d.length)return[]}-1!==h.indexOf(b,3)&&this.timeInfo&&(f=0<d.length?d:this.graphics,a=a.timeExtent,d=this._filterByTime(f,a.startTime,a.endTime).match);return e?h.map(d,function(a){return a.attributes[c]},this):d},_filterByTime:function(a,b,e){var d=this._startTimeField,f=this._endTimeField,c;this._twoTimeFields||(c=d||f);var g=s.isDefined,m=[],l=[],n,h=a.length,k,p;b=b?b.getTime():-Infinity;e=e?e.getTime():Infinity;if(c)for(n=0;n<h;n++)k=a[n],p=k.attributes,
d=p[c],d>=b&&d<=e?m.push(k):l.push(k);else for(n=0;n<h;n++)k=a[n],p=k.attributes,c=p[d],p=p[f],c=g(c)?c:-Infinity,p=g(p)?p:Infinity,c>=b&&c<=e||p>=b&&p<=e||b>=c&&e<=p?m.push(k):l.push(k);return{match:m,noMatch:l}},_resolve:function(a,b,e,d,c){b&&this[b].apply(this,a);e&&e.apply(null,a);d&&f._resDfd(d,a,c)},_getShallowClone:function(a){var b=new z,e;for(e in a)a.hasOwnProperty(e)&&(b[e]=a[e]);return b},_query:function(a,b,e,c,g){var m=this,l=this._map,n=new p(f._dfdCanceller),h=e,k=function(e,d){if(!d&&
"execute"===a&&!m._isTable){var f=e.features,g=m._mode,l=m.objectIdField,h;for(h=f.length-1;0<=h;h--){var k=g._getFeature(f[h].attributes[l]);k&&f.splice(h,1,k)}}m._resolve([e],b,c,n)};if("executeRelationshipQuery"!==a){h=this._getShallowClone(e);h.outFields=this.getOutFields();h.returnGeometry=e.hasOwnProperty("returnGeometry")?e.returnGeometry:!0;var s;l&&(h.outSpatialReference=new d(l.spatialReference.toJson()));if(!this._applyQueryFilters(h,"execute"===a)){switch(a){case "execute":s=new D({features:[]});
break;case "executeForIds":s=[];break;case "executeForCount":s=0}k(s,!0);return n}if(e=this._canDoClientSideQuery(h)){h=this._doQuery(h,e,"executeForIds"===a||"executeForCount"===a);switch(a){case "execute":s=new D;s.features=h;break;case "executeForIds":s=h;break;case "executeForCount":s=h.length}k(s,!0);return n}}if(this._collection)return this._resolve([Error("FeatureLayer::_query - "+this.invalidParams)],null,g,n,!0),n;this._ts&&(h._ts=(new Date).getTime());(n._pendingDfd=this._task[a](h)).addCallbacks(k,
function(a){m._resolve([a],null,g,n,!0)});return n},_convertFeaturesToJson:function(a,b,e,d){var f=[],c=this._selectionSymbol,g=this.visibilityField,m,l=this.objectIdField;if(this.loaded&&(e||d))m=h.filter(this.fields,function(a){return!1===a.editable&&(!d||a.name!==l)});for(e=0;e<a.length;e++){var n=a[e],k={},p=n.geometry,s=n.attributes,t=n.symbol;if(p&&(!d||!this.loaded||this.allowGeometryUpdates))k.geometry=p.toJson();g?(k.attributes=s=q.mixin({},s),s[g]=n.visible?1:0):s&&(k.attributes=q.mixin({},
s));k.attributes&&(m&&m.length)&&h.forEach(m,function(a){delete k.attributes[a.name]});t&&t!==c&&(k.symbol=t.toJson());f.push(k)}return b?f:r.toJson(f)},_selectHandler:function(a,b,e,d,f){var c;d=this.constructor;switch(b){case d.SELECTION_NEW:this.clearSelection(!0);c=!0;break;case d.SELECTION_ADD:c=!0;break;case d.SELECTION_SUBTRACT:c=!1}d=a.features;var g=this._mode,m=[],l=this.objectIdField,n,h;if(c)for(c=0;c<d.length;c++)n=d[c],h=n.attributes[l],n=g._addFeatureIIf(h,n),m.push(n),this._selectFeatureIIf(h,
n,g);else for(c=0;c<d.length;c++)n=d[c],h=n.attributes[l],this._unSelectFeatureIIf(h,g),h=g._removeFeatureIIf(h),m.push(h||n);this._isSelOnly&&g._applyTimeFilter(!0);this._resolve([m,b,a.exceededTransferLimit?{queryLimitExceeded:!0}:null],"onSelectionComplete",e,f);if(a.exceededTransferLimit)this.onQueryLimitExceeded()},_selectFeatureIIf:function(a,b,e){var d=this._selectedFeatures,f=d[a];f||(e._incRefCount(a),d[a]=b,this._isTable||(this._setSelectSymbol(b),b.attr("data-selected","")));return f||
b},_unSelectFeatureIIf:function(a,b){var e=this._selectedFeatures[a];e&&(b._decRefCount(a),delete this._selectedFeatures[a],this._isTable||(this._setUnSelectSymbol(e),e.attr("data-selected")));return e},_isSelected:function(a){},_setSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&a.setSymbol(b)},_setUnSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&b===a.symbol&&a.setSymbol(null,!0)},_getOutFields:function(){var a=[this.objectIdField,this.typeIdField,
this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields).concat(this.dataAttributes),a=h.filter(a,function(a,b,e){return!!a&&h.indexOf(e,a)===b}),b=q.clone(this._outFields);if(b){if(-1!==h.indexOf(b,"*"))return b;h.forEach(a,function(a){-1===h.indexOf(b,a)&&b.push(a)});return b}return a},_checkFields:function(a){var b=a||this._getOutFields();h.forEach(b,function(a){"*"!==a&&(this._getField(a)||console.debug("esri.layers.FeatureLayer: "+s.substitute({url:this.url,
field:a},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]")))},this);!a&&(!this._isTable&&!this._fserver&&!this._collection)&&(h.some(this.fields,function(a){return a&&"esriFieldTypeGeometry"===a.type?!0:!1})||console.debug("esri.layers.FeatureLayer: "+s.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]")))},_fixRendererFields:function(){var a=
this.renderer;this._orderBy=null;if(a&&0<this.fields.length){var b=[],e,d,a=h.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],s.isDefined),f=[].concat(a);h.forEach(a,function(a){h.forEach(a.rendererInfos,function(a){a.renderer&&f.push(a.renderer)})});h.forEach(f,function(a){if((d=a.attributeField)&&!q.isFunction(d))if(e=!this._getField(d)&&this._getField(d,!0))a.attributeField=e.name;if(d=a.attributeField2)if(e=!this._getField(d)&&this._getField(d,!0))a.attributeField2=
e.name;if(d=a.attributeField3)if(e=!this._getField(d)&&this._getField(d,!0))a.attributeField3=e.name;q.isFunction(a.attributeField)||b.push(a.attributeField);b.push(a.attributeField2);b.push(a.attributeField3);if((d=a.rotationInfo&&a.rotationInfo.field)&&!q.isFunction(d)){if(e=!this._getField(d)&&this._getField(d,!0))d=a.rotationInfo.field=e.name;b.push(d)}if(a.proportionalSymbolInfo){if((d=a.proportionalSymbolInfo.field)&&!q.isFunction(d)){if(e=!this._getField(d)&&this._getField(d,!0))d=a.proportionalSymbolInfo.field=
e.name;b.push(d);this._orderBy||(this._orderBy=[d+" DESC"])}if((d=a.proportionalSymbolInfo.normalizationField)&&!q.isFunction(d)){if(e=!this._getField(d)&&this._getField(d,!0))d=a.proportionalSymbolInfo.normalizationField=e.name;b.push(d)}}if(a.colorInfo){if((d=a.colorInfo.field)&&!q.isFunction(d)){if(e=!this._getField(d)&&this._getField(d,!0))d=a.colorInfo.field=e.name;b.push(d)}if((d=a.colorInfo.normalizationField)&&!q.isFunction(d)){if(e=!this._getField(d)&&this._getField(d,!0))d=a.colorInfo.normalizationField=
e.name;b.push(d)}}if(!this._orderBy&&a.addBreak&&!q.isFunction(a.attributeField)&&(a.backgroundFillSymbol||this._hasSizeDiff(a)))this._orderBy=[a.attributeField+" DESC"]},this);this._rendererFields=h.filter(b,s.isDefined)}},_hasSizeDiff:function(a){var b=Number.MAX_VALUE,e=-Number.MAX_VALUE,d,f;h.forEach(a.infos,function(a){if(f=a.symbol){d=0;switch(f.type){case "simplemarkersymbol":d=f.size;break;case "picturemarkersymbol":d=(f.width+f.height)/2;break;case "simplelinesymbol":case "cartographiclinesymbol":d=
f.width;break;case "simplefillsymbol":case "picturefillsymbol":d=f.outline&&f.outline.width}d&&(b=Math.min(b,d),e=Math.max(e,d))}});return b!==Number.MAX_VALUE&&e!==-Number.MAX_VALUE&&1<Math.abs(e-b)},getOrderByFields:function(){var a=this.orderByFields||this._orderBy;return a&&a.length?a:null},_getField:function(a,b){var e=this.fields;if(!e||0===e.length)return null;var d;b&&(a=a.toLowerCase());h.some(e,function(e){var f=!1;(f=b?e&&e.name.toLowerCase()===a?!0:!1:e&&e.name===a?!0:!1)&&(d=e);return f});
return d},_getDateOpts:function(){this._dtOpts||(this._dtOpts={properties:h.map(h.filter(this.fields,function(a){return!!(a&&"esriFieldTypeDate"===a.type)}),function(a){return a.name})});return this._dtOpts},_applyNormalized:function(a,b){a&&b&&h.forEach(a,function(a,e){a&&b[e]&&a.setGeometry(b[e])})},_editHandler:function(a,b,e,d,f,c){f=a.addResults;var g=a.updateResults;a=a.deleteResults;var m,l,n,k,p=this.objectIdField,s=this._mode,q=this._isTable;m=this.editFieldsInfo;var r=this.getOutFields()||
[],t=m&&m.creatorField,x=m&&m.creationDateField,y=m&&m.editorField,v=m&&m.editDateField;m=m&&m.realm;-1===h.indexOf(r,"*")&&(t&&-1===h.indexOf(r,t)&&(t=null),x&&-1===h.indexOf(r,x)&&(x=null),y&&-1===h.indexOf(r,y)&&(y=null),v&&-1===h.indexOf(r,v)&&(v=null));var r=x||v?(new Date).getTime():null,u=t||y?this.getUserId():void 0;u&&m&&(u=u+"@"+m);if(f)for(m=0;m<f.length;m++)f[m]=new M(f[m]),q||(l=f[m],l.success&&(l=l.objectId,n=b[m],(k=n._graphicsLayer)&&k!==this&&k.remove(n),k=n.attributes||{},k[p]=l,
t&&(k[t]=u),y&&(k[y]=u),x&&(k[x]=r),v&&(k[v]=r),n.setAttributes(k),s._init&&s.drawFeature(n)));if(g)for(m=0;m<g.length;m++)if(g[m]=new M(g[m]),!q&&(l=g[m],l.success)){l=l.objectId;n=e[l];if(b=s._getFeature(l))b.geometry!==n.geometry&&b.setGeometry(N.fromJson(n.geometry.toJson())),this._repaint(b,l);n=b||n;k=n.attributes||{};y&&(k[y]=u);v&&(k[v]=r);n.setAttributes(k)}if(a){e=[];for(m=0;m<a.length;m++)if(a[m]=new M(a[m]),!q&&(l=a[m],l.success&&(l=l.objectId,n=s._getFeature(l))))this._unSelectFeatureIIf(l,
s)&&e.push(n),n._count=0,s._removeFeatureIIf(l);if(0<e.length)this.onSelectionComplete(e,this.constructor.SELECTION_SUBTRACT)}this._resolve([f,g,a],"onEditsComplete",d,c)},_sendAttachment:function(a,b,d,f,c){var g=this;return e({url:this._url.path+"/"+b+"/"+("add"===a?"addAttachment":"updateAttachment"),form:d,content:q.mixin(this._url.query,{f:"json",token:this._getToken()||void 0}),callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(e){var d="add"===a?"onAddAttachmentComplete":
"onUpdateAttachmentComplete";e=new M(e["add"===a?"addAttachmentResult":"updateAttachmentResult"]);e.attachmentId=e.objectId;e.objectId=b;g._resolve([e],d,f);return e}).addErrback(function(a){g._resolve([a],null,c,null,!0)})},_repaint:function(a,b,e){b=s.isDefined(b)?b:a.attributes[this.objectIdField];(!(b in this._selectedFeatures)||!this._selectionSymbol)&&a.setSymbol(a.symbol,e)},_getKind:function(a){var b=this._trackManager;return b?b.isLatestObservation(a)?1:0:0}});q.mixin(k,{MODE_SNAPSHOT:0,
MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});Z._createWrappers(k);n("extend-esri")&&q.setObject("layers.FeatureLayer",k,a);return k})},"dojo/DeferredList":function(){define(["./_base/kernel","./_base/Deferred","./_base/array"],function(k,c,q){k.DeferredList=function(h,k,p,g,n){var b=[];c.call(this);var m=this;0===h.length&&
!k&&this.resolve([0,[]]);var l=0;q.forEach(h,function(a,c){function e(a,e){b[c]=[a,e];l++;l===h.length&&m.resolve(b)}a.then(function(a){k?m.resolve([c,a]):e(!0,a)},function(a){p?m.reject(a):e(!1,a);if(g)return null;throw a;})})};k.DeferredList.prototype=new c;k.DeferredList.prototype.gatherResults=function(c){c=new k.DeferredList(c,!1,!0,!1);c.addCallback(function(c){var h=[];q.forEach(c,function(c){h.push(c[1])});return h});return c};return k.DeferredList})},"esri/layers/KMLFolder":function(){define(["dojo/_base/declare",
"dojo/_base/lang","dojo/has","esri/kernel","esri/lang"],function(k,c,q,h,r){k=k(null,{declaredClass:"esri.layers.KMLFolder",constructor:function(h){c.mixin(this,h);r.isDefined(this.visibility)&&(this.visible=!!this.visibility)}});q("extend-esri")&&c.setObject("layers.KMLFolder",k,h);return k})},"esri/layers/TrackManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has esri/kernel esri/graphic esri/geometry/Polyline esri/layers/GraphicsLayer".split(" "),function(k,c,
q,h,r,p,g,n){k=k(null,{declaredClass:"esri.layers._TrackManager",constructor:function(b){this.layer=b;this.trackMap={}},initialize:function(b){this.map=b;var c=this.layer,g=c._getRenderer(),g=g&&g.trackRenderer;if("esriGeometryPoint"===c.geometryType){var a=this.container=new n._GraphicsLayer({id:c.id+"_tracks",_child:!0});a.loaded=!0;a.onLoad(a);a._setMap(b,c._div);a.setRenderer(g)}},addFeatures:function(b){var c,g=this.trackMap,a=this.layer,n=a._trackIdField,e,f;q.forEach(b,function(a){e=a.attributes;
c=e[n];f=g[c]=g[c]||[];f.push(a)});var d=a._startTimeField,h=a.objectIdField;b=function(a,b){var e=a.attributes[d],f=b.attributes[d];return e===f?a.attributes[h]<b.attributes[h]?-1:1:e<f?-1:1};for(c in g)g[c].sort(b)},drawTracks:function(){var b=this.container;if(b){var c=this.trackMap,l=this.map.spatialReference,a,n,e,f,d,h=this.layer._trackIdField;for(a in c){n=c[a];e=[];for(f=n.length-1;0<=f;f--)(d=n[f].geometry)&&e.push([d.x,d.y]);n={};n[h]=a;0<e.length&&b.add(new p(new g({paths:[e],spatialReference:l}),
null,n))}}},moveLatestToFront:function(){q.forEach(this.getLatestObservations(),function(b){var c=b._shape;c&&c._moveToFront();this._repaint(b,null,!0)},this.layer)},getLatestObservations:function(){var b=[],c=this.layer._getRenderer(),g=this.trackMap,a;if(!c.latestObservationRenderer)return b;for(a in g)c=g[a],b.push(c[c.length-1]);return b},clearTracks:function(){var b=this.getLatestObservations();this.trackMap={};var c=this.container;c&&c.clear();q.forEach(b,function(b){this._repaint(b,null,!0)},
this.layer)},isLatestObservation:function(b){var c=this.trackMap[b.attributes[this.layer._trackIdField]];return c?c[c.length-1]===b:!1},destroy:function(){var b=this.container;b&&(b.clear(),b._unsetMap(this.map,this.layer._div));this.map=this.layer=this.trackMap=this.container=null}});h("extend-esri")&&c.setObject("layers._TrackManager",k,r);return k})},"esri/layers/WMSLayer":function(){define("require dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has esri/kernel esri/request esri/urlUtils esri/SpatialReference esri/geometry/Extent esri/layers/DynamicMapServiceLayer esri/layers/WMSLayerInfo dojo/query".split(" "),
function(k,c,q,h,r,p,g,n,b,m,l,a,s){q=q([a],{declaredClass:"esri.layers.WMSLayer",_CRS_TO_EPSG:{84:4326,83:4269,27:4267},_REVERSED_LAT_LONG_RANGES:[[4001,4999],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,
3366],[3416,3416],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],_WEB_MERCATOR:[102100,3857,102113,900913],_WORLD_MERCATOR:[3395,54004],allExtents:[],constructor:function(a,f){this.url=a=this._stripParameters(a,"version service request bbox format height width layers srs crs styles transparent bgcolor exceptions time elevation sld wfs".split(" "));
this._url=b.urlToObject(a);this._getCapabilitiesURL=a;this._initLayer=h.hitch(this,this._initLayer);this._parseCapabilities=h.hitch(this,this._parseCapabilities);this._getCapabilitiesError=h.hitch(this,this._getCapabilitiesError);f?(this.imageFormat=this._getImageFormat(f.format),this.imageTransparency=!1===f.transparent?!1:!0,this.visibleLayers=f.visibleLayers?f.visibleLayers:[],f.resourceInfo?this._readResourceInfo(f.resourceInfo):this._getCapabilities()):(this.imageFormat="image/png",this.imageTransparency=
!0,this.visibleLayers=[],this._getCapabilities());this._blankImageURL=k.toUrl("esri/layers")+"/../images/pixel.png"},setVisibleLayers:function(a){this.visibleLayers=(a=this._checkVisibleLayersList(a))?a:[];this.refresh(!0)},setImageFormat:function(a){this.imageFormat=this._getImageFormat(a);this.refresh(!0)},setImageTransparency:function(a){this.imageTransparency=a;this.refresh(!0)},getImageUrl:function(a,f,d,c){if(!this.visibleLayers||0===this.visibleLayers.length)c(this._blankImageURL);else{var g=
a.spatialReference.wkid;if(r.some(this._WEB_MERCATOR,function(a){return a==g})){var m=r.filter(this.spatialReferences,function(a){return r.some(this._WEB_MERCATOR,function(b){return b==a})},this);0==m.length&&(m=r.filter(this.spatialReferences,function(a){return r.some(this._WORLD_MERCATOR,function(b){return b==a})},this));g=0<m.length?m[0]:this._WEB_MERCATOR[0]}this.spatialReferences=r.filter(this.spatialReferences,function(a){return a!==g});this.spatialReferences.unshift(g);var m=a.xmin,n=a.xmax,
l=a.ymin,h=a.ymax;a={SERVICE:"WMS",REQUEST:"GetMap"};a.FORMAT=this.imageFormat;a.TRANSPARENT=this.imageTransparency?"TRUE":"FALSE";a.STYLES="";a.VERSION=this.version;a.LAYERS=this.visibleLayers?this.visibleLayers.toString():null;a.WIDTH=f;a.HEIGHT=d;this.maxWidth<f&&(a.WIDTH=this.maxWidth);this.maxHeight<d&&(a.HEIGHT=this.maxHeight);f=g?g:NaN;isNaN(f)||("1.3.0"==this.version?a.CRS="EPSG:"+f:a.SRS="EPSG:"+f);"1.3.0"==this.version&&this._useLatLong(f)?a.BBOX=l+","+m+","+h+","+n:a.BBOX=m+","+l+","+n+
","+h;f=this.getMapURL;var k;f+=-1==f.indexOf("?")?"?":"";for(k in a)f+="?"==f.substring(f.length-1,f.length)?"":"\x26",f+=k+"\x3d"+a[k];c(b.addProxy(f))}},_initLayer:function(a,b){this.spatialReference=new m(this.extent.spatialReference);this.initialExtent=new l(this.extent);this.fullExtent=new l(this.extent);this.visibleLayers=this._checkVisibleLayersList(this.visibleLayers);this.loaded=!0;this.onLoad(this);var d=this._loadCallback;d&&(delete this._loadCallback,d(this))},_readResourceInfo:function(a){a.extent?
a.layerInfos?(this.extent=a.extent,this.allExtents[0]=a.extent,this.layerInfos=a.layerInfos,this.description=a.description?a.description:"",this.copyright=a.copyright?a.copyright:"",this.title=a.title?a.title:"",this.getMapURL=a.getMapURL?a.getMapURL:this._getCapabilitiesURL,this.version=a.version?a.version:"1.3.0",this.maxWidth=a.maxWidth?a.maxWidth:5E3,this.maxHeight=a.maxHeight?a.maxHeight:5E3,this.spatialReferences=a.spatialReferences?a.spatialReferences:[],this.imageFormat=this._getImageFormat(a.format),
this.setScaleRange(a.minScale,a.maxScale),this._initLayer()):console.error("esri.layers.WMSLayer: unable to find the 'layerInfos' property in resourceInfo"):console.error("esri.layers.WMSLayer: unable to find the 'extent' property in resourceInfo")},_getCapabilities:function(){var a=this._url.query?this._url.query:{};a.SERVICE="WMS";a.REQUEST="GetCapabilities";var b=this._url.path+"?",d;for(d in a)b+="?"==b.substring(b.length-1,b.length)?"":"\x26",b+=d+"\x3d"+a[d];n({url:b,handleAs:"xml",headers:{"Content-Type":null},
load:this._parseCapabilities,error:this._getCapabilitiesError},{usePost:!1})},_parseCapabilities:function(a){if(a){this.version=this._getAttributeValue("WMS_Capabilities","version",a,null);this.version||(this.version=this._getAttributeValue("WMT_MS_Capabilities","version",a,"1.3.0"));var b=this._getTag("Service",a);this.title=this._getTagValue("Title",b,"");if(!this.title||0==this.title.length)this.title=this._getTagValue("Name",b,"");this.copyright=this._getTagValue("AccessConstraints",b,"");this.description=
this._getTagValue("Abstract",b,"");this.maxWidth=parseInt(this._getTagValue("MaxWidth",b,5E3),10);this.maxHeight=parseInt(this._getTagValue("MaxHeight",b,5E3),10);if(b=this._getTag("Layer",a)){var d=this._getLayerInfo(b),g=0,m=null,b=this._getTag("Capability",a);r.forEach(b.childNodes,function(a){"Layer"==a.nodeName&&(0===g?m=a:(1===g&&d.name&&(d.name="",d.subLayers=[],d.subLayers.push(this._getLayerInfo(m))),d.subLayers.push(this._getLayerInfo(a))),g++)},this);if(d){this.layerInfos=d.subLayers;if(!this.layerInfos||
0==this.layerInfos.length)this.layerInfos=[d];this.extent=d.extent;this.allExtents=d.allExtents;this.spatialReferences=d.spatialReferences;0==this.spatialReferences.length&&0<this.layerInfos.length&&(this.spatialReferences=this.layerInfos[0].spatialReferences)}this.getMapURL=this._getCapabilitiesURL;if((b=c.query("DCPType",this._getTag("GetMap",a)))&&0<b.length)if((b=c.query("HTTP",b[0]))&&0<b.length)if((b=c.query("Get",b[0]))&&0<b.length)if(b=this._getAttributeValue("OnlineResource","xlink:href",
b[0],null))b.indexOf("\x26")==b.length-1&&(b=b.substring(0,b.length-1)),this.getMapURL=b;this.getMapFormats=[];0==c.query("Operation",a).length?r.forEach(c.query("Format",this._getTag("GetMap",a)),function(a){this.getMapFormats.push(a.text?a.text:a.textContent)},this):r.forEach(c.query("Operation",a),function(a){"GetMap"==a.getAttribute("name")&&r.forEach(c.query("Format",a),function(a){this.getMapFormats.push(a.text?a.text:a.textContent)},this)},this);r.some(this.getMapFormats,function(a){return-1<
a.indexOf(this.imageFormat)},this)||(this.imageFormat=this.getMapFormats[0]);this._initLayer()}else this._getCapabilitiesError({error:{message:"Response does not contain any layers."}})}else this.onError("GetCapabilities request for "+this._getCapabilitiesURL+" failed. (Response is null.)")},_getCapabilitiesError:function(a,b){this.onError("GetCapabilities request for "+this._getCapabilitiesURL+" failed.",a)},_getLayerInfo:function(a){if(!a)return null;var b=new s;b.name="";b.title="";b.description=
"";b.allExtents=[];b.spatialReferences=[];b.subLayers=[];var d=this._getTag("LatLonBoundingBox",a);d&&(b.allExtents[0]=this._getExtent(d,4326));if(d=this._getTag("EX_GeographicBoundingBox",a)){var c=new l(0,0,0,0,new m({wkid:4326}));c.xmin=parseFloat(this._getTagValue("westBoundLongitude",d,0));c.ymin=parseFloat(this._getTagValue("southBoundLatitude",d,0));c.xmax=parseFloat(this._getTagValue("eastBoundLongitude",d,0));c.ymax=parseFloat(this._getTagValue("northBoundLatitude",d,0));b.allExtents[0]=
c}b.extent=b.allExtents[0];var g=-1<r.indexOf(["1.0.0","1.1.0","1.1.1"],this.version)?"SRS":"CRS";r.forEach(a.childNodes,function(a){if("Name"==a.nodeName)b.name=(a.text?a.text:a.textContent)||"";else if("Title"==a.nodeName)b.title=(a.text?a.text:a.textContent)||"";else if("Abstract"==a.nodeName)b.description=(a.text?a.text:a.textContent)||"";else if("BoundingBox"==a.nodeName){var d=a.getAttribute(g);d&&0===d.indexOf("EPSG:")?(d=parseInt(d.substring(5),10),0!==d&&!isNaN(d)&&(a="1.3.0"==this.version?
this._getExtent(a,d,this._useLatLong(d)):this._getExtent(a,d),b.allExtents[d]=a,b.extent||(b.extent=a))):d&&0===d.indexOf("CRS:")?(d=parseInt(d.substring(4),10),0!==d&&!isNaN(d)&&(this._CRS_TO_EPSG[d]&&(d=this._CRS_TO_EPSG[d]),b.allExtents[d]=this._getExtent(a,d))):(d=parseInt(d,10),0!==d&&!isNaN(d)&&(b.allExtents[d]=this._getExtent(a,d)))}else if(a.nodeName==g)a=(a.text?a.text:a.textContent).split(" "),r.forEach(a,function(a){a=-1<a.indexOf(":")?parseInt(a.split(":")[1],10):parseInt(a,10);0!==a&&
!isNaN(a)&&(this._CRS_TO_EPSG[a]&&(a=this._CRS_TO_EPSG[a]),-1==r.indexOf(b.spatialReferences,a)&&b.spatialReferences.push(a))},this);else if("Style"==a.nodeName){if(a=this._getTag("LegendURL",a))if(a=this._getTag("OnlineResource",a))b.legendURL=a.getAttribute("xlink:href")}else"Layer"===a.nodeName&&b.subLayers.push(this._getLayerInfo(a))},this);b.title=b.title||b.name;return b},_getImageFormat:function(a){switch(a?a.toLowerCase():""){case "jpg":return"image/jpeg";case "bmp":return"image/bmp";case "gif":return"image/gif";
case "svg":return"image/svg+xml";default:return"image/png"}},getImageFormat:function(){switch(this.imageFormat?this.imageFormat.toLowerCase():""){case "image/jpeg":return"jpg";case "image/bmp":return"bmp";case "image/gif":return"gif";case "image/svg+xml":return"svg";default:return"png"}},_getExtent:function(a,b,d){var c;if(a){c=new l;var g=parseFloat(a.getAttribute("minx")),n=parseFloat(a.getAttribute("miny")),h=parseFloat(a.getAttribute("maxx"));a=parseFloat(a.getAttribute("maxy"));d?(c.xmin=isNaN(n)?
-1*Number.MAX_VALUE:n,c.ymin=isNaN(g)?-1*Number.MAX_VALUE:g,c.xmax=isNaN(a)?Number.MAX_VALUE:a,c.ymax=isNaN(h)?Number.MAX_VALUE:h):(c.xmin=isNaN(g)?-1*Number.MAX_VALUE:g,c.ymin=isNaN(n)?-1*Number.MAX_VALUE:n,c.xmax=isNaN(h)?Number.MAX_VALUE:h,c.ymax=isNaN(a)?Number.MAX_VALUE:a);c.spatialReference=new m({wkid:b})}return c},_useLatLong:function(a){var b,d;for(d=0;d<this._REVERSED_LAT_LONG_RANGES.length;d++){var c=this._REVERSED_LAT_LONG_RANGES[d];if(a>=c[0]&&a<=c[1]){b=!0;break}}return b},_getTag:function(a,
b){var d=c.query(a,b);return d&&0<d.length?d[0]:null},_getTagValue:function(a,b,d){return(a=c.query(a,b))&&0<a.length?a[0].text?a[0].text:a[0].textContent:d},_getAttributeValue:function(a,b,d,g){return(a=c.query(a,d))&&0<a.length?a[0].getAttribute(b):g},_checkVisibleLayersList:function(a){if(a&&(0<a.length&&this.layerInfos&&0<this.layerInfos.length)&&"number"==typeof a[0]){var b=[];r.forEach(a,function(a){a<this.layerInfos.length&&b.push(this.layerInfos[a].name)},this);a=b}return a},_stripParameters:function(a,
c){var d=b.urlToObject(a),g,m=[];for(g in d.query)-1===r.indexOf(c,g.toLowerCase())&&m.push(g+"\x3d"+d.query[g]);return d.path+(m.length?"?"+m.join("\x26"):"")}});p("extend-esri")&&h.setObject("layers.WMSLayer",q,g);return q})},"esri/layers/SnapshotMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/has esri/kernel esri/SpatialReference esri/tasks/query esri/layers/RenderMode".split(" "),function(k,c,q,h,r,p,g){k=k([g],{declaredClass:"esri.layers._SnapshotMode",constructor:function(g){this.featureLayer=
g;this._featureMap={};this._drawFeatures=c.hitch(this,this._drawFeatures);this._queryErrorHandler=c.hitch(this,this._queryErrorHandler)},startup:function(){this.featureLayer._collection?this._applyTimeFilter():this._fetchAll()},propertyChangeHandler:function(c){this._init&&(c?this.featureLayer._collection?console.log("FeatureLayer: layer created by value (from a feature collection) does not support definition expressions and time definitions. Layer id \x3d "+this.featureLayer.id):this._fetchAll():
this._applyTimeFilter())},drawFeature:function(c){var b=c.attributes[this.featureLayer.objectIdField];this._addFeatureIIf(b,c);this._incRefCount(b)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var c=this.featureLayer;c._collection?(c._fireUpdateStart(),c._refresh(!0),c._fireUpdateEnd()):this._fetchAll()},_getRequestId:function(c){return("_"+c.name+c.layerId+c._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchAll:function(){var c=this.featureLayer;!c._collection&&!c.suspended&&
(c._fireUpdateStart(),this._clearIIf(),this._sendRequest())},_sendRequest:function(){var c=this.map,b=this.featureLayer,g=b.getDefinitionExpression(),l=new p;l.outFields=b.getOutFields();l.where=g||"1\x3d1";l.returnGeometry=!0;l.outSpatialReference=new r(c.spatialReference.toJson());l.timeExtent=b.getTimeDefinition();l.maxAllowableOffset=b._maxOffset;b._ts&&(l._ts=(new Date).getTime());l.orderByFields=b.supportsAdvancedQueries?b.getOrderByFields():null;var a;b._usePatch&&(a=this._getRequestId(b),
this._cancelPendingRequest(null,a));b._task.execute(l,this._drawFeatures,this._queryErrorHandler,a)},_drawFeatures:function(c){this._purgeRequests();var b=c.features,g=this.featureLayer,l=g.objectIdField,a,h=b.length,e,f;for(a=0;a<h;a++)e=b[a],f=e.attributes[l],this._addFeatureIIf(f,e),this._incRefCount(f);this._applyTimeFilter(!0);g._fireUpdateEnd(null,c.exceededTransferLimit?{queryLimitExceeded:!0}:null);if(c.exceededTransferLimit)g.onQueryLimitExceeded()},_queryErrorHandler:function(c){this._purgeRequests();
var b=this.featureLayer;b._errorHandler(c);b._fireUpdateEnd(c)}});q("extend-esri")&&c.setObject("layers._SnapshotMode",k,h);return k})},"esri/layers/SelectionMode":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","esri/kernel","esri/layers/RenderMode"],function(k,c,q,h,r){k=k([r],{declaredClass:"esri.layers._SelectionMode",constructor:function(c){this.featureLayer=c;this._featureMap={}},propertyChangeHandler:function(c){this._init&&0===c&&this._applyTimeFilter()},resume:function(){this.propertyChangeHandler(0)}});
q("extend-esri")&&c.setObject("layers._SelectionMode",k,h);return k})},"esri/layers/GridLayout":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has esri/kernel esri/SpatialReference esri/geometry/Extent esri/geometry/Polyline".split(" "),function(k,c,q,h,r,p,g,n){k=k(null,{declaredClass:"esri.layers._GridLayout",constructor:function(b,c,g,a){this.origin=b;this.cellWidth=c.width;this.cellHeight=c.height;this.mapWidth=g.width;this.mapHeight=g.height;this.srInfo=a},setResolution:function(b){this._resolution=
(b.xmax-b.xmin)/this.mapWidth;this.srInfo&&(b=Math.round(2*this.srInfo.valid[1]/this._resolution),b=Math.round(b/this.cellWidth),this._frameStats=[b,0,b-1])},getCellCoordinates:function(b){var c=this._resolution,g=this.origin;return{row:Math.floor((g.y-b.y)/(this.cellHeight*c)),col:Math.floor((b.x-g.x)/(this.cellWidth*c))}},normalize:function(b){var c=this._frameStats;if(c){var g=c[0],a=c[1],c=c[2];b<a?(b%=g,b=b<a?b+g:b):b>c&&(b%=g)}return b},intersects:function(b,c){var g=this.srInfo;return g?q.some(c._getParts(g),
function(a){return b.intersects(a.extent)}):b.intersects(c)},getCellExtent:function(b,c){var l=this._resolution,a=this.origin,n=this.cellWidth,e=this.cellHeight;return new g(c*n*l+a.x,a.y-(b+1)*e*l,(c+1)*n*l+a.x,a.y-b*e*l,new p(a.spatialReference.toJson()))},getLatticeID:function(b){var c=this.getCellCoordinates({x:b.xmin,y:b.ymax}),g=this.getCellCoordinates({x:b.xmax,y:b.ymin});b=c.row;var a=g.row,c=this.normalize(c.col),g=this.normalize(g.col);return b+"_"+a+"_"+c+"_"+g},sorter:function(b,c){return b<
c?-1:1},getCellsInExtent:function(b,c){var g=this.getCellCoordinates({x:b.xmin,y:b.ymax}),a=this.getCellCoordinates({x:b.xmax,y:b.ymin}),h=g.row,e=a.row,g=g.col,a=a.col,f=[],d,k,p,q=[],r=[],G,H,y,u=[];for(d=h;d<=e;d++)for(k=g;k<=a;k++)p=this.normalize(k),b=this.getCellExtent(d,p),f.push({row:d,col:p,extent:b,resolution:this._resolution}),c&&(q.push(b.xmin,b.xmax),r.push(b.ymin,b.ymax));g=this.normalize(g);a=this.normalize(a);q.sort(this.sorter);r.sort(this.sorter);k=q.length;for(d=k-1;0<=d;d--)d<
k-1&&q[d]===q[d+1]&&q.splice(d,1);k=r.length;for(d=k-1;0<=d;d--)d<k-1&&r[d]===r[d+1]&&r.splice(d,1);if(q.length&&r.length){p=q[0];G=q[q.length-1];H=r[0];y=r[r.length-1];k=q.length;for(d=0;d<k;d++)u.push([[q[d],y],[q[d],H]]);k=r.length;for(d=0;d<k;d++)u.push([[p,r[d]],[G,r[d]]]);d=new n({paths:u,spatialReference:this.origin.spatialReference.toJson()});f.push({latticeID:h+"_"+e+"_"+g+"_"+a,lattice:d,resolution:this._resolution})}return{minRow:h,maxRow:e,minCol:g,maxCol:a,cells:f}}});h("extend-esri")&&
c.setObject("layers._GridLayout",k,r);return k})},"dojox/data/CsvStore":function(){define("dojo/_base/lang dojo/_base/declare dojo/_base/xhr dojo/_base/kernel dojo/data/util/filter dojo/data/util/simpleFetch".split(" "),function(k,c,q,h,r,p){c=c("dojox.data.CsvStore",null,{constructor:function(c){this._attributes=[];this._attributeIndexes={};this._dataArray=[];this._arrayOfAllItems=[];this._loadFinished=!1;c.url&&(this.url=c.url);this._csvData=c.data;c.label?this.label=c.label:""===this.label&&(this.label=
void 0);this._storeProp="_csvStore";this._idProp="_csvId";this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0};this._loadInProgress=!1;this._queuedFetches=[];this.identifier=c.identifier;""===this.identifier?delete this.identifier:this._idMap={};"separator"in c&&(this.separator=c.separator);"urlPreventCache"in c&&(this.urlPreventCache=c.urlPreventCache?!0:!1)},url:"",label:"",identifier:"",separator:",",urlPreventCache:!1,_assertIsItem:function(c){if(!this.isItem(c))throw Error(this.declaredClass+
": a function was passed an item argument that was not an item");},_getIndex:function(c){c=this.getIdentity(c);this.identifier&&(c=this._idMap[c]);return c},getValue:function(c,n,b){this._assertIsItem(c);var m=b;if("string"===typeof n)n=this._attributeIndexes[n],null!=n&&(m=this._dataArray[this._getIndex(c)][n]||b);else throw Error(this.declaredClass+": a function was passed an attribute argument that was not a string");return m},getValues:function(c,n){var b=this.getValue(c,n);return b?[b]:[]},getAttributes:function(c){this._assertIsItem(c);
var n=[];c=this._dataArray[this._getIndex(c)];for(var b=0;b<c.length;b++)""!==c[b]&&n.push(this._attributes[b]);return n},hasAttribute:function(c,n){this._assertIsItem(c);if("string"===typeof n){var b=this._attributeIndexes[n],m=this._dataArray[this._getIndex(c)];return"undefined"!==typeof b&&b<m.length&&""!==m[b]}throw Error(this.declaredClass+": a function was passed an attribute argument that was not a string");},containsValue:function(c,n,b){var m=void 0;"string"===typeof b&&(m=r.patternToRegExp(b,
!1));return this._containsValue(c,n,b,m)},_containsValue:function(c,n,b,m){c=this.getValues(c,n);for(n=0;n<c.length;++n){var l=c[n];if("string"===typeof l&&m)return null!==l.match(m);if(b===l)return!0}return!1},isItem:function(c){if(c&&c[this._storeProp]===this)if(c=c[this._idProp],this.identifier){if(this._dataArray[this._idMap[c]])return!0}else if(0<=c&&c<this._dataArray.length)return!0;return!1},isItemLoaded:function(c){return this.isItem(c)},loadItem:function(c){},getFeatures:function(){return this._features},
getLabel:function(c){if(this.label&&this.isItem(c))return this.getValue(c,this.label)},getLabelAttributes:function(c){return this.label?[this.label]:null},_fetchItems:function(c,n,b){var m=this,l=function(a,b){var c=null;if(a.query){var e,f,c=[],g=a.queryOptions?a.queryOptions.ignoreCase:!1,l={};for(e in a.query)f=a.query[e],"string"===typeof f&&(l[e]=r.patternToRegExp(f,g));for(g=0;g<b.length;++g){var h=!0,k=b[g];for(e in a.query)f=a.query[e],m._containsValue(k,e,f,l[e])||(h=!1);h&&c.push(k)}}else c=
b.slice(0,b.length);n(c,a)};if(this._loadFinished)l(c,this._arrayOfAllItems);else if(""!==this.url)if(this._loadInProgress)this._queuedFetches.push({args:c,filter:l});else{this._loadInProgress=!0;var a=q.get({url:m.url,handleAs:"text",preventCache:m.urlPreventCache});a.addCallback(function(a){try{m._processData(a),l(c,m._arrayOfAllItems),m._handleQueuedFetches()}catch(e){b(e,c)}});a.addErrback(function(a){m._loadInProgress=!1;if(b)b(a,c);else throw a;});var h=null;c.abort&&(h=c.abort);c.abort=function(){a&&
-1===a.fired&&a.cancel();h&&h.call(c)}}else if(this._csvData)try{this._processData(this._csvData),this._csvData=null,l(c,this._arrayOfAllItems)}catch(e){b(e,c)}else{var f=Error(this.declaredClass+": No CSV source data was provided as either URL or String data input.");if(b)b(f,c);else throw f;}},close:function(c){},_getArrayOfArraysFromCsvFileContents:function(c){if(k.isString(c)){var n=RegExp("^\\s+","g"),b=RegExp("\\s+$","g"),m=RegExp('""',"g"),l=[],a=this._splitLines(c);for(c=0;c<a.length;++c){var h=
a[c];if(0<h.length){for(var h=h.split(this.separator),e=0;e<h.length;){var f=h[e].replace(n,""),d=f.replace(b,""),p=d.charAt(0),q=d.charAt(d.length-1),r=d.charAt(d.length-2),v=d.charAt(d.length-3);if(2===d.length&&'""'==d)h[e]="";else if('"'==p&&('"'!=q||'"'==q&&'"'==r&&'"'!=v)){if(e+1===h.length)return;h[e]=f+this.separator+h[e+1];h.splice(e+1,1)}else'"'==p&&'"'==q&&(d=d.slice(1,d.length-1),d=d.replace(m,'"')),h[e]=d,e+=1}l.push(h)}}this._attributes=l.shift();for(c=0;c<this._attributes.length;c++)this._attributeIndexes[this._attributes[c]]=
c;this._dataArray=l}},_splitLines:function(c){var h=[],b,m="",l=!1;for(b=0;b<c.length;b++){var a=c.charAt(b);switch(a){case '"':l=!l;m+=a;break;case "\r":l?m+=a:(h.push(m),m="",b<c.length-1&&"\n"==c.charAt(b+1)&&b++);break;case "\n":l?m+=a:(h.push(m),m="");break;default:m+=a}}""!==m&&h.push(m);return h},_processData:function(c){this._getArrayOfArraysFromCsvFileContents(c);this._arrayOfAllItems=[];if(this.identifier&&void 0===this._attributeIndexes[this.identifier])throw Error(this.declaredClass+": Identity specified is not a column header in the data set.");
for(c=0;c<this._dataArray.length;c++){var h=c;this.identifier&&(h=this._dataArray[c][this._attributeIndexes[this.identifier]],this._idMap[h]=c);this._arrayOfAllItems.push(this._createItemFromIdentity(h))}this._loadFinished=!0;this._loadInProgress=!1},_createItemFromIdentity:function(c){var h={};h[this._storeProp]=this;h[this._idProp]=c;return h},getIdentity:function(c){return this.isItem(c)?c[this._idProp]:null},fetchItemByIdentity:function(c){var n,b=c.scope?c.scope:h.global;if(this._loadFinished)n=
this._createItemFromIdentity(c.identity),this.isItem(n)||(n=null),c.onItem&&c.onItem.call(b,n);else{var m=this;if(""!==this.url)this._loadInProgress?this._queuedFetches.push({args:c}):(this._loadInProgress=!0,n=q.get({url:m.url,handleAs:"text"}),n.addCallback(function(a){try{m._processData(a);var h=m._createItemFromIdentity(c.identity);m.isItem(h)||(h=null);c.onItem&&c.onItem.call(b,h);m._handleQueuedFetches()}catch(e){c.onError&&c.onError.call(b,e)}}),n.addErrback(function(a){this._loadInProgress=
!1;c.onError&&c.onError.call(b,a)}));else if(this._csvData)try{m._processData(m._csvData),m._csvData=null,n=m._createItemFromIdentity(c.identity),m.isItem(n)||(n=null),c.onItem&&c.onItem.call(b,n)}catch(l){c.onError&&c.onError.call(b,l)}}},getIdentityAttributes:function(c){return this.identifier?[this.identifier]:null},_handleQueuedFetches:function(){if(0<this._queuedFetches.length){for(var c=0;c<this._queuedFetches.length;c++){var h=this._queuedFetches[c],b=h.filter,m=h.args;b?b(m,this._arrayOfAllItems):
this.fetchItemByIdentity(h.args)}this._queuedFetches=[]}}});k.extend(c,p);return c})},"esri/arcgis/csv":function(){define("dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/sniff dojo/number dojox/data/CsvStore esri/kernel esri/config esri/request esri/SpatialReference esri/geometry/Point esri/geometry/Geometry esri/geometry/jsonUtils esri/geometry/webMercatorUtils".split(" "),function(k,c,q,h,r,p,g,n,b,m,l,a,s,e){function f(a){var b=0,d="";c.forEach([","," ",";","|","\t"],function(c){var e=
a.split(c).length;e>b&&(b=e,d=c)});return d}function d(a,b){if(!a||"[object Date]"!==Object.prototype.toString.call(a)||isNaN(a.getTime()))return!1;var c=!0;if(h("chrome")&&/\d+\W*$/.test(b)){var d=b.match(/[a-zA-Z]{2,}/);if(d){for(var c=!1,e=0,f=d.length,g=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;!c&&e<=f&&!(c=!g.test(d[e]));)e++;c=!c}}return c}function x(a,b,e){var g=
a.indexOf("\n"),g=k.trim(a.substr(0,g)),n=b.columnDelimiter;n||(n=f(g));var q=new p({data:a,separator:n});a=9>h("ie")?750:1001;q.fetch({start:0,count:a,onComplete:function(a,f){var g=0,h={layerDefinition:b.layerDefinition,featureSet:{features:[],geometryType:"esriGeometryPoint"}},n=h.layerDefinition.objectIdField;!n&&!c.some(h.layerDefinition.fields,function(a){return"esriFieldTypeOID"==a.type?(n=a.name,!0):!1})&&(h.layerDefinition.fields.push({name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",
editable:!1,domain:null}),n="__OBJECTID");var k,p,s=q._attributes,y=[],D=[];c.forEach(h.layerDefinition.fields,function(a,b){"esriFieldTypeDate"===a.type?y.push(a.name):("esriFieldTypeDouble"===a.type||"esriFieldTypeInteger"===a.type)&&D.push(a.name)});b.locationInfo&&"coordinates"===b.locationInfo.locationType?(k=b.locationInfo.latitudeFieldName,p=b.locationInfo.longitudeFieldName):c.forEach(s,function(a){var b;b=c.indexOf(G,a.toLowerCase());-1!==b&&(k=a);b=c.indexOf(H,a.toLowerCase());-1!==b&&(p=
a)},this);if(!k||!p)setTimeout(function(){console.error("File does not seem to contain fields with point coordinates.")},1);else{var s=0,t=a.length;for(s;s<t;s++){if(1E3<=h.featureSet.features.length){setTimeout(function(){console.error("1000 feature limit reached. Unable to load any more data.")},1);break}var v=a[s],F=q.getAttributes(v),x={};c.forEach(F,function(a,b){if(a){var e=a;0===a.length&&c.forEach(h.layerDefinition.fields,function(b,c){b.name==="attribute_"+(c-1)&&(a="attribute_"+(c-1))});
if(c.some(y,function(b){return b===a})){var e=q.getValue(v,e),f=new Date(e);x[a]=d(f,e)?f.getTime():null}else if(c.some(D,function(b){return b===a})){f=r.parse(q.getValue(v,e));if((a==k||a==p)&&(isNaN(f)||181<Math.abs(f)))f=parseFloat(q.getValue(v,e));isNaN(f)?x[a]=null:x[a]=f}else x[a]=q.getValue(v,e)}});x[n]=g;g++;var F=x[k],B=x[p];null==B||(null==F||isNaN(F)||isNaN(B))||(F={geometry:(new l(B,F,new m({wkid:4326}))).toJson(),attributes:x},h.featureSet.features.push(F))}h.layerDefinition.name="csv";
e&&e(h)}},onError:function(a){console.error("Error fetching items from CSV store: ",a)}});return!0}function B(a,b,d,f,g,h){0===a.length&&g(null);var m=s.getGeometryType(b),l=[];c.forEach(a,function(a){a=new m(a);a.spatialReference=d;l.push(a)},this);b=[102113,102100,3857];d.wkid&&4326===d.wkid&&f.wkid&&-1<c.indexOf(b,f.wkid)?(c.forEach(l,function(a){a.xmin?(a.xmin=Math.max(a.xmin,-180),a.xmax=Math.min(a.xmax,180),a.ymin=Math.max(a.ymin,-89.99),a.ymax=Math.min(a.ymax,89.99)):a.rings?c.forEach(a.rings,
function(a){c.forEach(a,function(a){a[0]=Math.min(Math.max(a[0],-180),180);a[1]=Math.min(Math.max(a[1],-89.99),89.99)},this)},this):a.paths?c.forEach(a.paths,function(a){c.forEach(a,function(a){a[0]=Math.min(Math.max(a[0],-180),180);a[1]=Math.min(Math.max(a[1],-89.99),89.99)},this)},this):a.x&&(a.x=Math.min(Math.max(a.x,-180),180),a.y=Math.min(Math.max(a.y,-89.99),89.99))},this),a=[],c.forEach(l,function(b){b=e.geographicToWebMercator(b);102100!==f.wkid&&(b.spatialReference=f);a.push(b.toJson())},
this),g(a)):null!==d.wkid&&-1<c.indexOf(b,d.wkid)&&null!==f.wkid&&4326===f.wkid?(a=[],c.forEach(l,function(b){a.push(e.webMercatorToGeographic(b).toJson())},this),g(a)):(b=function(b,d){b&&b.length===a.length?(a=[],c.forEach(b,function(b){b&&(b.rings&&0<b.rings.length&&0<b.rings[0].length&&0<b.rings[0][0].length&&!isNaN(b.rings[0][0][0])&&!isNaN(b.rings[0][0][1])||b.paths&&0<b.paths.length&&0<b.paths[0].length&&0<b.paths[0][0].length&&!isNaN(b.paths[0][0][0])&&!isNaN(b.paths[0][0][1])||b.xmin&&!isNaN(b.xmin)&&
b.ymin&&!isNaN(b.ymin)||b.x&&!isNaN(b.x)&&b.y&&!isNaN(b.y))?a.push(b.toJson()):a.push(null)},this),g(a)):h(b,d)},n.defaults.geometryService?n.defaults.geometryService.project(l,f,k.hitch(this,b),h):g(null))}function t(a,b){var d=[102113,102100,3857];return a&&b&&a.wkid===b.wkid&&a.wkt===b.wkt||a&&b&&a.wkid&&b.wkid&&-1<c.indexOf(d,a.wkid)&&-1<c.indexOf(d,b.wkid)?!0:!1}function v(a,b,d,e){if(a.featureSet&&0!==a.featureSet.features.length)if(t(d,b))e(a);else{var f=function(b){var d=[];c.forEach(a.featureSet.features,
function(a,c){b[c]&&(a.geometry=b[c],d.push(a))},this);e(a)},g=function(b,c){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Final try.");e(a)},h=function(c,e){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Try one more time.");B(l,a.featureSet.geometryType,b,d,k.hitch(this,f),k.hitch(this,g))};if(a.featureSet.features&&0<a.featureSet.features.length){var l=[];c.forEach(a.featureSet.features,function(b){if(b.geometry.toJson)l.push(b.geometry);else{var c=
s.getGeometryType(a.featureSet.geometryType);l.push(new c(b.geometry))}});b.toJson||(b=new m(b));d.toJson||(d=new m(d));B(l,a.featureSet.geometryType,b,d,k.hitch(this,f),k.hitch(this,h))}else e(a)}}var G="lat latitude y ycenter latitude83 latdecdeg POINT-Y".split(" "),H="lon lng long longitude x xcenter longitude83 longdecdeg POINT-X".split(" ");a={latFieldStrings:G,longFieldStrings:H,buildCSVFeatureCollection:function(a){var c=new q,d=function(a){c.callback(a)};b({url:a.url,handleAs:"text",load:function(b){x(b,
a,k.hitch(this,d))},error:function(a){console.error("error: "+a)}},{usePost:!1});return c},projectFeatureCollection:function(a,b,c){var d=new q;c||(c=new m({wkid:4326}));v(a,c,b,k.hitch(this,function(a){d.callback(a)}));return d},generateDefaultPopupInfo:function(a){var b={esriFieldTypeDouble:1,esriFieldTypeSingle:1},d={esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1},e={esriFieldTypeDate:1},f=null;a=c.map(a.layerDefinition.fields,k.hitch(this,function(a){"NAME"===a.name.toUpperCase()&&(f=a.name);
var c="esriFieldTypeOID"!==a.type&&"esriFieldTypeGlobalID"!==a.type&&"esriFieldTypeGeometry"!==a.type,g=null;if(c){var h=a.name.toLowerCase();if(-1<",stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,".indexOf(","+h+",")||-1<h.indexOf("area")||-1<h.indexOf("length")||-1<h.indexOf("shape")||-1<h.indexOf("perimeter")||-1<h.indexOf("objectid")||h.indexOf("_")===h.length-1||h.indexOf("_i")===h.length-2&&1<h.length)c=!1;a.type in d?g={places:0,digitSeparator:!0}:a.type in
b?g={places:2,digitSeparator:!0}:a.type in e&&(g={dateFormat:"shortDateShortTime"})}return k.mixin({},{fieldName:a.name,label:a.alias,isEditable:!0,tooltip:"",visible:c,format:g,stringFieldOption:"textbox"})}));return{title:f?"{"+f+"}":"",fieldInfos:a,description:null,showAttachments:!1,mediaInfos:[]}},_getSeparator:f,_isValidDate:d,_processCsvData:x,_projectGeometries:B,_sameSpatialReference:t,_projectFeatureSet:v};h("extend-esri")&&k.setObject("arcgis.csv",a,g);return a})},"dojo/data/util/filter":function(){define(["../../_base/lang"],
function(k){var c={};k.setObject("dojo.data.util.filter",c);c.patternToRegExp=function(c,h){for(var k="^",p=null,g=0;g<c.length;g++)switch(p=c.charAt(g),p){case "\\":k+=p;g++;k+=c.charAt(g);break;case "*":k+=".*";break;case "?":k+=".";break;case "$":case "^":case "/":case "+":case ".":case "|":case "(":case ")":case "{":case "}":case "[":case "]":k+="\\";default:k+=p}k+="$";return h?RegExp(k,"mi"):RegExp(k,"m")};return c})},"esri/layers/WMSLayerInfo":function(){define(["dojo/_base/declare","dojo/_base/lang",
"dojo/_base/array","dojo/has","esri/kernel"],function(k,c,q,h,r){k=k(null,{declaredClass:"esri.layers.WMSLayerInfo",name:null,title:null,description:null,extent:null,legendURL:null,subLayers:[],allExtents:[],spatialReferences:[],constructor:function(c){c&&(this.name=c.name,this.title=c.title,this.description=c.description,this.extent=c.extent,this.legendURL=c.legendURL,this.subLayers=c.subLayers?c.subLayers:[],this.allExtents=c.allExtents?c.allExtents:[],this.spatialReferences=c.spatialReferences?
c.spatialReferences:[])},clone:function(){var c={name:this.name,title:this.title,description:this.description,legendURL:this.legendURL},g;this.extent&&(c.extent=this.extent.getExtent());c.subLayers=[];q.forEach(this.subLayers,function(g){c.subLayers.push(g.clone())});c.allExtents=[];for(g in this.allExtents)g=parseInt(g,10),isNaN(g)||(c.allExtents[g]=this.allExtents[g].getExtent());c.spatialReferences=[];q.forEach(this.spatialReferences,function(g){c.spatialReferences.push(g)});return c}});h("extend-esri")&&
c.setObject("layers.WMSLayerInfo",k,r);return k})},"esri/layers/FeatureType":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has esri/kernel esri/lang esri/symbols/jsonUtils esri/layers/RangeDomain esri/layers/CodedValueDomain esri/layers/InheritedDomain esri/layers/FeatureTemplate".split(" "),function(k,c,q,h,r,p,g,n,b,m,l){k=k(null,{declaredClass:"esri.layers.FeatureType",constructor:function(a){if(a&&c.isObject(a)){this.id=a.id;this.name=a.name;var h=a.symbol;h&&(this.symbol=
g.fromJson(h));var h=a.domains,e,f=this.domains={};for(e in h)if(h.hasOwnProperty(e)){var d=h[e];switch(d.type){case "range":f[e]=new n(d);break;case "codedValue":f[e]=new b(d);break;case "inherited":f[e]=new m(d)}}if(e=a.templates){h=this.templates=[];for(a=0;a<e.length;a++)h.push(new l(e[a]))}}},toJson:function(){var a={id:this.id,name:this.name,symbol:this.symbol&&this.symbol.toJson()},b,c=this.domains,f=this.templates,d=p.fixJson;if(c){var g=a.domains={};for(b in c)c.hasOwnProperty(b)&&(g[b]=
c[b]&&c[b].toJson());d(g)}f&&(a.templates=q.map(f,function(a){return a.toJson()}));return d(a)}});h("extend-esri")&&c.setObject("layers.FeatureType",k,r);return k})},"esri/layers/RenderMode":function(){define("dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/io/script esri/kernel".split(" "),function(k,c,q,h,r,p,g){c=c(null,{declaredClass:"esri.layers._RenderMode",constructor:function(){this._prefix="jsonp_"+(k._scopeName||"dojo")+"IoScript"},initialize:function(c){this.map=
c;this._init=!0},startup:function(){},propertyChangeHandler:function(c){},destroy:function(){this._init=!1},drawFeature:function(c){},suspend:function(){},resume:function(){},refresh:function(){},_incRefCount:function(c){(c=this._featureMap[c])&&c._count++},_decRefCount:function(c){(c=this._featureMap[c])&&c._count--},_getFeature:function(c){return this._featureMap[c]},_addFeatureIIf:function(c,b){var g=this._featureMap,h=g[c],a=this.featureLayer;h||(g[c]=b,a._add(b),b._count=0);return h||b},_removeFeatureIIf:function(c){var b=
this._featureMap[c],g=this.featureLayer;if(b){if(b._count)return;delete this._featureMap[c];g._remove(b)}return b},_clearIIf:function(){var c;c=this.featureLayer;var b=c.graphics,g=c._selectedFeatures,h=c.objectIdField;for(c=b.length-1;0<=c;c--){var a=b[c],k=a.attributes[h];k in g?a._count=1:(a._count=0,this._removeFeatureIIf(k))}},_isPending:function(c){return p[this._prefix+c]?!0:!1},_cancelPendingRequest:function(c,b){if(c=c||p[this._prefix+b])try{c.cancel(),p._validCheck(c)}catch(g){}},_purgeRequests:function(){p._validCheck(null)},
_toggleVisibility:function(c){var b=this.featureLayer,g=b.graphics,h=c?"show":"hide",a,k=g.length;c=c&&b._ager;for(a=0;a<k;a++){var e=g[a];e[h]();c&&b._repaint(e)}},_applyTimeFilter:function(c){var b=this.featureLayer;if(b.timeInfo&&!b.suspended){c||b._fireUpdateStart();var g=b._trackManager;g&&g.clearTracks();var k=b.getTimeDefinition(),a=b._getOffsettedTE(b._mapTimeExtent);a?(a=b._getTimeOverlap(k,a))?(k=b._filterByTime(b.graphics,a.startTime,a.endTime),g&&g.addFeatures(k.match),h.forEach(k.match,
function(a){var c=a._shape;a.visible||(a.show(),(c=a._shape)&&c._moveToFront());b._ager&&c&&b._repaint(a)}),h.forEach(k.noMatch,function(a){a.visible&&a.hide()})):this._toggleVisibility(!1):(g&&g.addFeatures(b.graphics),this._toggleVisibility(!0));g&&(g.moveLatestToFront(),g.drawTracks());c||b._fireUpdateEnd()}}});r("extend-esri")&&q.setObject("layers._RenderMode",c,g);return c})},"esri/layers/GeoRSSLayer":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/json dojo/has esri/kernel esri/config esri/request esri/layers/ServiceGeneratedFeatureCollection".split(" "),
function(k,c,q,h,r,p,g,n){k=k([n],{declaredClass:"esri.layers.GeoRSSLayer",serviceUrl:location.protocol+"//utility.arcgis.com/sharing/rss",constructor:function(b,c){p.defaults.geoRSSService&&(this.serviceUrl=p.defaults.geoRSSService);this._createLayer()},parse:function(){return this._io=g({url:this.serviceUrl,content:{url:this.url,refresh:this.loaded?!0:void 0,outSR:this._outSR?q.toJson(this._outSR.toJson()):void 0},callbackParamName:"callback"})},_initLayer:function(b){this.inherited(arguments);
this.loaded||(this.loaded=!0,this.onLoad(this))}});h("extend-esri")&&c.setObject("layers.GeoRSSLayer",k,r);return k})},"esri/layers/FeatureTemplate":function(){define("dojo/_base/declare dojo/_base/lang dojo/has esri/kernel esri/lang esri/graphic".split(" "),function(k,c,q,h,r,p){k=k(null,{declaredClass:"esri.layers.FeatureTemplate",constructor:function(g){g&&c.isObject(g)&&(this.name=g.name,this.description=g.description,this.drawingTool=g.drawingTool,g=g.prototype,this.prototype=new p(g.geometry,
null,g.attributes))},toJson:function(){return r.fixJson({name:this.name,description:this.description,drawingTool:this.drawingTool,prototype:this.prototype&&this.prototype.toJson()})}});c.mixin(k,{TOOL_AUTO_COMPLETE_POLYGON:"esriFeatureEditToolAutoCompletePolygon",TOOL_CIRCLE:"esriFeatureEditToolCircle",TOOL_ELLIPSE:"esriFeatureEditToolEllipse",TOOL_FREEHAND:"esriFeatureEditToolFreehand",TOOL_LINE:"esriFeatureEditToolLine",TOOL_NONE:"esriFeatureEditToolNone",TOOL_POINT:"esriFeatureEditToolPoint",TOOL_POLYGON:"esriFeatureEditToolPolygon",
TOOL_RECTANGLE:"esriFeatureEditToolRectangle",TOOL_ARROW:"esriFeatureEditToolArrow",TOOL_TRIANGLE:"esriFeatureEditToolTriangle",TOOL_LEFT_ARROW:"esriFeatureEditToolLeftArrow",TOOL_RIGHT_ARROW:"esriFeatureEditToolRightArrow",TOOL_UP_ARROW:"esriFeatureEditToolUpArrow",TOOL_DOWN_ARROW:"esriFeatureEditToolDownArrow"});q("extend-esri")&&c.setObject("layers.FeatureTemplate",k,h);return k})},"*noref":1}});
define("esri/arcgis/utils","dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/Deferred dojo/_base/json dojo/_base/url dojo/has dojo/DeferredList dojo/dom-construct esri/kernel esri/config esri/lang esri/request esri/SpatialReference esri/map esri/urlUtils esri/geometry/ScreenPoint esri/geometry/Extent esri/geometry/webMercatorUtils esri/symbols/jsonUtils esri/renderers/jsonUtils esri/dijit/PopupTemplate esri/dijit/Popup esri/tasks/query esri/tasks/GeometryService esri/arcgis/csv esri/layers/ArcGISTiledMapServiceLayer esri/layers/ArcGISDynamicMapServiceLayer esri/layers/ArcGISImageServiceLayer esri/layers/OpenStreetMapLayer esri/layers/WebTiledLayer esri/layers/FeatureLayer esri/layers/WMSLayer esri/layers/KMLLayer esri/layers/GeoRSSLayer esri/virtualearth/VETiledLayer esri/layers/TileInfo esri/layers/DynamicLayerInfo esri/layers/LayerDrawingOptions esri/layers/ImageParameters esri/layers/ImageServiceParameters esri/layers/RasterFunction esri/layers/MosaicRule esri/layers/WMSLayerInfo dojo/i18n!esri/nls/jsapi".split(" "),function(k,
c,q,h,r,p,g,n,b,m,l,a,s,e,f,d,x,B,t,v,G,H,y,u,z,D,F,N,Z,O,$,J,aa,ba,M,P,R,ca,da,ea,Ha,Ia,Ja,Ka,fa){function Q(a){return s({url:C.arcgisUrl+"/"+a.itemId+"/data",content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function ma(a){var b={f:"json"};if(m.id){var c=m.id.findCredential(d.urlToObject(C.arcgisUrl).path);c&&(b.token=c.token)}return s({url:a,content:b,callbackParamName:"callback"},{disableIdentityLookup:!0})}function na(b){b.itemProperties.layerDefinition&&
(b.layerDefinition?(b.layerDefinition.drawingInfo||(b.layerDefinition.drawingInfo=b.itemProperties.layerDefinition.drawingInfo),a.isDefined(b.layerDefinition.definitionExpression)||(b.layerDefinition.definitionExpression=b.itemProperties.layerDefinition.definitionExpression),a.isDefined(b.layerDefinition.minScale)||(b.layerDefinition.minScale=b.itemProperties.layerDefinition.minScale),a.isDefined(b.layerDefinition.maxScale)||(b.layerDefinition.maxScale=b.itemProperties.layerDefinition.maxScale)):
b.layerDefinition=b.itemProperties.layerDefinition);b.itemProperties.popupInfo&&(!b.popupInfo&&!b.disablePopup)&&(b.popupInfo=b.itemProperties.popupInfo);a.isDefined(b.itemProperties.showLegend)&&!a.isDefined(b.showLegend)&&(b.showLegend=b.itemProperties.showLegend);a.isDefined(b.itemProperties.refreshInterval)&&!a.isDefined(b.refreshInterval)&&(b.refreshInterval=b.itemProperties.refreshInterval)}function S(b,d){var e=new h,f=b.itemData,g=[],k=[];c.forEach(f.operationalLayers,function(b){if(b.itemId&&
!b.type){var c=b.url.toLowerCase();-1<c.indexOf("/featureserver")||-1<c.indexOf("/mapserver/")?(k.push(b),g.push(Q(b))):-1<c.indexOf("/mapserver")&&-1===c.indexOf("/mapserver/")&&(!b.layers||!a.isDefined(b.minScale)&&!a.isDefined(b.maxScale))?(k.push(b),g.push(Q(b))):-1<c.indexOf("/imageserver")&&(!a.isDefined(b.minScale)&&!a.isDefined(b.maxScale))&&(k.push(b),g.push(Q(b)))}});f.baseMap&&f.baseMap.baseMapLayers&&c.forEach(f.baseMap.baseMapLayers,function(a){("BingMapsAerial"===a.type||"BingMapsRoad"===
a.type||"BingMapsHybrid"===a.type)&&a.portalUrl?(delete d.bingMapsKey,k.push(a),g.push(ma(a.portalUrl))):a.itemId&&(k.push(a),g.push(Q(a)))});0<g.length?(new n(g)).addCallback(function(f){c.forEach(k,function(b,e){if(("BingMapsAerial"===b.type||"BingMapsRoad"===b.type||"BingMapsHybrid"===b.type)&&b.portalUrl)f[e][1].bingKey?d.bingMapsKey=f[e][1].bingKey:(b.errors=b.errors||[],b.errors.push({message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. [type:"+b.type+"]"}));
else{var w=f[e][1];if(w&&!b.type){var g=b.url.toLowerCase();(-1<g.indexOf("/featureserver")||-1<g.indexOf("/mapserver/"))&&w.layers?c.forEach(w.layers,function(a){if(g.endsWith("/featureserver/"+a.id)||g.endsWith("/mapserver/"+a.id))b.itemProperties=a,na(b)}):-1<g.indexOf("/mapserver")?(w.layers&&!b.layers&&(b.layers=w.layers),a.isDefined(w.minScale)&&!a.isDefined(b.minScale)&&(b.minScale=w.minScale),a.isDefined(w.maxScale)&&!a.isDefined(b.maxScale)&&(b.maxScale=w.maxScale),a.isDefined(w.refreshInterval)&&
!a.isDefined(b.refreshInterval)&&(b.refreshInterval=w.refreshInterval)):-1<g.indexOf("/imageserver")&&(a.isDefined(w.minScale)&&!a.isDefined(b.minScale)&&(b.minScale=w.minScale),a.isDefined(w.maxScale)&&!a.isDefined(b.maxScale)&&(b.maxScale=w.maxScale),a.isDefined(w.refreshInterval)&&!a.isDefined(b.refreshInterval)&&(b.refreshInterval=w.refreshInterval),w.popupInfo&&(!b.popupInfo&&!b.disablePopup)&&(b.popupInfo=w.popupInfo),w.renderingRule&&!b.renderingRule&&(b.renderingRule=w.renderingRule,w.renderingRule.functionName&&
(b.renderingRule.rasterFunction=w.renderingRule.functionName)),w.bandIds&&!b.bandIds&&(b.bandIds=w.bandIds),w.mosaicRule&&!b.mosaicRule&&(b.mosaicRule=w.mosaicRule),w.format&&!b.format&&(b.format=w.format),a.isDefined(w.compressionQuality)&&!a.isDefined(b.compressionQuality)&&(b.compressionQuality=w.compressionQuality))}}});e.callback(b)}):e.callback(b);return e}function ga(b,d){var e=b.dynamicLayerInfos||b.layerInfos,f=d.layers;if(f&&e){var g=[],h=[],k=[],m=[],l=[],n=[];c.forEach(e,function(d){var e=
d.id;if(!d.subLayerIds&&-1!==c.indexOf(b.visibleLayers,e))for(d=0;d<f.length;d++){var K=f[d];if(K.id===e){h.push(e);g.push(K.popupInfo);k.push(K.layerUrl||"");K.layerDefinition&&K.layerDefinition.definitionExpression?m.push(K.layerDefinition.definitionExpression):m.push("");l.push(a.isDefined(K.minScale)?K.minScale:null);n.push(a.isDefined(K.maxScale)?K.maxScale:null);break}}});g.length&&(b.__popups=g,b.__popupIds=h,b.__popupUrls=k,b.__popupWhereClauses=m,b.__popupMinScales=l,b.__popupMaxScales=n,
b.__resourceInfo=d.resourceInfo)}}function oa(a){if(!a)return!1;var b=(new p(C.arcgisUrl)).authority;return-1!==a.indexOf(".arcgis.com/")||-1!==a.indexOf(b)}function pa(a){return!a?!1:-1!==a.indexOf("/services.arcgisonline.com/")||-1!==a.indexOf("/server.arcgisonline.com/")}function A(a){if("https:"===location.protocol&&(oa(a)||pa(a)))a=a.replace("http:","https:");return a}function E(a){var b=[];a.displayLevels||(b=c.map(a.resourceInfo.tileInfo.lods,function(a){return a.level}));b=new F(A(a.url),
{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,displayLevels:a.displayLevels||b,id:a.id,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval});ga(b,a);return b}function ha(a,b){if(!a||!b||0===b.length)return[];var c=","+b+",",d=[],e,f=",";for(e=0;e<a.length;e++)if(null!==a[e].subLayerIds){if(-1===c.indexOf(","+a[e].id+",")||-1<f.indexOf(","+a[e].id+","))f+=a[e].subLayerIds.toString()+","}else-1<c.indexOf(","+a[e].id+",")&&-1===f.indexOf(","+a[e].id+",")&&
d.push(a[e].id);return d}function qa(a){var b=new ea;b.format="png24";a.resourceInfo&&(a.resourceInfo.supportedImageFormatTypes&&-1<a.resourceInfo.supportedImageFormatTypes.indexOf("PNG32"))&&(b.format="png32");var b=new N(A(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageParameters:b,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval}),d=a.visibleLayers;if(!a.visibleLayers){var e="";c.forEach(b.layerInfos,function(a){a.defaultVisibility&&
(e+=(0<e.length?",":"")+a.id)});d=e}if(a.layers&&0<a.layers.length){var f=[],g=[],h,m=[],l;c.forEach(a.layers,function(b){b.layerDefinition&&b.layerDefinition.definitionExpression&&(f[b.id]=b.layerDefinition.definitionExpression);if(b.layerDefinition&&b.layerDefinition.source){h=new ca(k.mixin(b,b.layerDefinition));delete h.layerDefinition;h.id=b.id;if(a.visibleLayers){var d="string"==typeof a.visibleLayers?a.visibleLayers.split(","):a.visibleLayers;-1<c.indexOf(d,b.id)?h.defaultVisibility=!0:h.defaultVisibility=
!1}g.push(h)}b.layerDefinition&&(b.layerDefinition.source&&b.layerDefinition.drawingInfo)&&(l=new da(b.layerDefinition.drawingInfo),m[b.id]=l)},this);0<f.length&&b.setLayerDefinitions(f);0<g.length?(b.setDynamicLayerInfos(g,!0),0<m.length&&b.setLayerDrawingOptions(m,!0)):(d=ha(b.layerInfos,d),b.setVisibleLayers(d))}else d=ha(b.layerInfos,d),b.setVisibleLayers(d);ga(b,a);return b}function La(b,c){var d=new Ha;d.bandIds=b.bandIds;null!=b.format&&(d.format=b.format,null!=b.compressionQuality&&(d.compressionQuality=
b.compressionQuality));if(b.renderingRule&&b.renderingRule.rasterFunction){var e=new Ia(b.renderingRule);d.renderingRule=e}b.mosaicRule&&(e=new Ja(b.mosaicRule),d.mosaicRule=e);a.isDefined(b.noData)&&(d.noData=b.noData);a.isDefined(b.noDataInterpretation)&&(d.noDataInterpretation=b.noDataInterpretation);a.isDefined(b.interpolation)&&(d.interpolation=b.interpolation);d=new Z(A(b.url),{resourceInfo:b.resourceInfo,opacity:b.opacity,visible:b.visibility,id:b.id,imageServiceParameters:d,infoTemplate:b.popupInfo&&
new c(b.popupInfo),minScale:b.minScale,maxScale:b.maxScale,refreshInterval:b.refreshInterval});b.layerDefinition&&b.layerDefinition.definitionExpression&&d.setDefinitionExpression(b.layerDefinition.definitionExpression,!0);return d}function ia(b,d,f){var g=[102113,102100,3857],h=f||new e(d[0].layerObject.fullExtent.spatialReference),k=new e(b.resourceInfo.fullExtent.spatialReference);return h.wkt==k.wkt&&(h.wkid==k.wkid||a.isDefined(h.latestWkid)&&h.latestWkid==k.wkid||a.isDefined(k.latestWkid)&&
h.wkid==k.latestWkid||a.isDefined(h.latestWkid)&&h.latestWkid==k.latestWkid)||h.wkid&&k.wkid&&c.some(g,function(a){return a===k.wkid})&&c.some(g,function(a){return a===h.wkid})?!0:!1}function ja(a,b){if(!b[0].layerObject.tileInfo)return!1;var d=[];c.forEach(b,function(a){a.baseMapLayer&&a.layerObject.tileInfo&&(d=d.concat(c.map(a.layerObject.tileInfo.lods,function(a){return a.scale})))});return c.some(a.resourceInfo.tileInfo.lods,function(a){return c.some(d,function(b){return b===a.scale})})}function ka(b,
f,g,h,l){var n,p=g._clazz;if("OpenStreetMap"===b.type)n=new O({id:b.id,opacity:b.opacity,visible:null!==b.visibility&&void 0!==b.visibility?b.visibility:!0});else if("WMS"===b.type){var s=[],ra=[];c.forEach(b.layers,function(a){ra.push(new Ka({name:a.name,title:a.title,legendURL:a.legendURL}));s.push(a.name)},this);b.visibleLayers&&(s=b.visibleLayers);h={extent:new B(b.extent[0][0],b.extent[0][1],b.extent[1][0],b.extent[1][1],new e({wkid:4326})),layerInfos:ra,version:b.version,maxWidth:b.maxWidth,
maxHeight:b.maxHeight,getMapURL:b.mapUrl,spatialReferences:b.spatialReferences,title:b.title,copyright:b.copyright};n=new aa(b.url,{id:b.id,visibleLayers:s,format:"png",transparent:b.baseMapLayer?!1:!0,opacity:b.opacity,visible:null!==b.visibility?b.visibility:!0,resourceInfo:h,refreshInterval:b.refreshInterval});n.spatialReference.wkid=h.spatialReferences[0]}else if("KML"===b.type){g=b.url;if(m.id&&(p=m.id.findCredential(d.urlToObject(C.arcgisUrl).path))){f=C.arcgisUrl.substring(C.arcgisUrl.indexOf("//")+
2,C.arcgisUrl.indexOf("/",C.arcgisUrl.indexOf("//")+3));l=f.split(".");l=l[l.length-2]+"."+l[l.length-1];var sa=g.indexOf(l);-1<sa&&(g="https://"+f+g.substring(sa+l.length));g+="?token\x3d"+p.token}n=new ba(g,{id:b.id,visible:null!==b.visibility?b.visibility:!0,outSR:h,refreshInterval:b.refreshInterval});q.connect(n,"onLoad",function(){var a=function(d){c.forEach(d,function(c){"esri.layers.FeatureLayer"===c.declaredClass||"esri.layers.MapImageLayer"===c.declaredClass?c.setOpacity(b.opacity):"esri.layers.KMLLayer"===
c.declaredClass&&(c.loaded?a(c.getLayers()):q.connect(c,"onLoad",k.hitch(this,function(b){a(b.getLayers())})))})};(b.opacity||0===b.opacity)&&a(n.getLayers());b.visibleFolders&&c.forEach(n.folders,function(a){-1<c.indexOf(b.visibleFolders,a.id)?n.setFolderVisibility(a,!0):n.setFolderVisibility(a,!1)},this)})}else"WebTiledLayer"===b.type?(n=new $(b.templateUrl,{id:b.id,visible:null!==b.visibility?b.visibility:!0,opacity:b.opacity,copyright:b.copyright,fullExtent:b.fullExtent&&new B(b.fullExtent),initialExtent:b.fullExtent&&
new B(b.fullExtent),subDomains:b.subDomains,tileInfo:b.tileInfo?new R(b.tileInfo):null,refreshInterval:b.refreshInterval}),q.connect(n,"onLoad",function(){(a.isDefined(b.minScale)||a.isDefined(b.maxScale))&&n.setScaleRange(b.minScale,b.maxScale)})):"GeoRSS"===b.type?(n=new M(b.url,{id:b.id,opacity:b.opacity,outSpatialReference:h,refreshInterval:b.refreshInterval}),q.connect(n,"onLoad",function(){!1===b.visibility&&n.hide();var d=n.getFeatureLayers();c.forEach(d,function(c){b.pointSymbol&&"esriGeometryPoint"===
c.geometryType?c.renderer.symbol=v.fromJson(b.pointSymbol):b.lineSymbol&&"esriGeometryPolyline"===c.geometryType?c.renderer.symbol=v.fromJson(b.lineSymbol):b.polygonSymbol&&"esriGeometryPolygon"===c.geometryType&&(c.renderer.symbol=v.fromJson(b.polygonSymbol));(a.isDefined(b.minScale)||a.isDefined(b.maxScale))&&c.setScaleRange(b.minScale,b.maxScale)})})):"CSV"==b.type&&b.url?n=new J(b.featureCollection,{infoTemplate:new H(b.popupInfo?b.popupInfo:D.generateDefaultPopupInfo(b.featureCollection)),id:b.id?
b.id:null,outFields:["*"],visible:null!==b.visibility?b.visibility:!0,opacity:b.opacity,autoGeneralize:!0}):b.layerDefinition&&!b.url?(h=r.fromJson(r.toJson(b)),delete h.id,delete h.opacity,delete h.visibility,n=new J(h,{id:b.id,opacity:b.opacity,visible:b.visibility,outFields:["*"],infoTemplate:h.popupInfo&&new p(h.popupInfo),autoGeneralize:!0})):"BingMapsAerial"===b.type||"BingMapsRoad"===b.type||"BingMapsHybrid"===b.type?g.bingMapsKey?(h=P.MAP_STYLE_AERIAL_WITH_LABELS,"BingMapsAerial"===b.type?
h=P.MAP_STYLE_AERIAL:"BingMapsRoad"===b.type&&(h=P.MAP_STYLE_ROAD),n=new P({bingMapsKey:g.bingMapsKey,mapStyle:h,opacity:b.opacity,id:b.id}),q.connect(n,"onError",dojo.hitch(this,function(a){a.errors=a.errors||[];a.errors.push({message:"This application does not have a valid Bing Key for the Bing layer that is included in this map. [type:"+a.type+"]"})},b))):(b.errors=b.errors||[],b.errors.push({message:"This application does not provide a Bing Key for the Bing layer that is included in this map. [type:"+
b.type+"]"})):b.resourceInfo&&b.resourceInfo.mapName?n=!0===b.resourceInfo.singleFusedMapCache&&(b.baseMapLayer||ia(b,f,h)&&ja(b,l))?E(b):qa(b):b.resourceInfo&&b.resourceInfo.pixelSizeX?n=!0===b.resourceInfo.singleFusedMapCache&&(b.baseMapLayer||ia(b,f,h)&&ja(b,l))?E(b):La(b,p):b.resourceInfo&&"Feature Layer"===b.resourceInfo.type&&(n=new J(A(b.url),{resourceInfo:b.resourceInfo,opacity:b.opacity,visible:b.visibility,id:b.id,mode:a.isDefined(b.mode)?b.mode:J.MODE_ONDEMAND,outFields:["*"],infoTemplate:b.popupInfo&&
new p(b.popupInfo),autoGeneralize:!0,refreshInterval:b.refreshInterval}),b.layerDefinition&&(b.layerDefinition.drawingInfo&&b.layerDefinition.drawingInfo.renderer&&(h=G.fromJson(b.layerDefinition.drawingInfo.renderer),h.isMaxInclusive=!0,n.setRenderer(h)),b.layerDefinition.definitionExpression&&n.setDefinitionExpression(b.layerDefinition.definitionExpression),a.isDefined(b.layerDefinition.minScale)&&n.setMinScale(b.layerDefinition.minScale),a.isDefined(b.layerDefinition.maxScale)&&n.setMaxScale(b.layerDefinition.maxScale)));
n&&(n.arcgisProps={title:b.title},b.baseMapLayer&&(n._basemapGalleryLayerType=b.isReference?"reference":"basemap"));return n}function T(a,b,d,e){c.forEach(a,function(c,f){if(c.url&&!c.type){if(0===f||a[0].layerObject)c.layerObject=ka(c,a,b,d,e)}else c.layerObject=ka(c,a,b,d,e)});var f=c.filter(a,function(a){return!a.isReference}),g=c.filter(a,function(a){return!!a.isReference});return a=f.concat(g)}function la(a){var b=null;a=a[0];a.url&&!a.type?a.resourceInfo.spatialReference&&(b=new e,a.resourceInfo.spatialReference.wkid&&
(b.wkid=a.resourceInfo.spatialReference.wkid),a.resourceInfo.spatialReference.wkt&&(b.wkt=a.resourceInfo.spatialReference.wkt)):-1<a.type.indexOf("BingMaps")||"OpenStreetMap"==a.type?b=new e({wkid:102100}):"WMS"==a.type&&(b=new e({wkid:a.spatialReferences[0]}));return b}function ta(a,b,d,e,f,g,h){c.forEach(b,function(b,c){b.url&&!b.type?(b.resourceInfo=a[b.deferredsPos][1],delete b.deferredsPos):b.url&&"CSV"==b.type&&(b.featureCollection=e[b.deferredsPos].results[0],delete b.deferredsPos)});g=g||
la(b);var k=[];c.forEach(b,function(a){a.url&&"CSV"==a.type&&(a.deferredsPos=k.length,k.push(D.projectFeatureCollection(a.featureCollection,g)))});0==k.length?(b=T(b,d,g,h),f.callback(b)):(new n(k)).addCallback(function(){c.forEach(b,function(a){a.url&&"CSV"==a.type&&(a.featureCollection=k[a.deferredsPos].results[0],delete a.deferredsPos)});b=T(b,d,g,h);f.callback(b)});return f}function ua(a,b){var c=A(a);return s({url:c,content:{f:"json"},callbackParamName:"callback",error:function(a,d){a.message=
a.message?a.message+(" [url:"+c+"]"):"[url:"+c+"]";b.push(a);l.defaults.io.errorHandler(a,d)}})}function va(a){var b=C.arcgisUrl+"/"+a.itemId+"/data";return s({url:b,content:{f:"json"},callbackParamName:"callback",error:function(c,d){c.message=c.message?c.message+(" [url:"+b+"]"):"[url:"+b+"]";a.errors=a.errors||[];a.errors.push(c);l.defaults.io.errorHandler(c,d)}})}function wa(b,c,d){var e=new h;if(!d.featureCollection||!d.featureCollection.layers)return console.log("Invalid Feature Collection item data [item id: "+
b.itemId+"]: ",d),b.errors=b.errors||[],b.errors.push({message:"Invalid Feature Collection item data. [item id: "+b.itemId+"]"}),e.errback(),e;xa(b,d.featureCollection,c).then(function(c){d.featureCollection=c;b.featureCollection&&b.featureCollection.layers?dojo.forEach(d.featureCollection.layers,function(c,d){var e=b.featureCollection.layers[d];if(!e.poupInfo&&!e.layerDefinition)e.popupInfo=c.popupInfo,e.layerDefinition=c.layerDefinition;else if(e.layerDefinition){if(a.isDefined(e.layerDefinition.minScale)&&
a.isDefined(e.layerDefinition.maxScale)&&(e.layerDefinition.minScale!==c.layerDefinition.minScale||e.layerDefinition.maxScale!==c.layerDefinition.maxScale))delete c.layerDefinition.minscale,delete c.layerDefinition.maxScale;e.layerDefinition.drawingInfo&&r.toJson(e.layerDefinition.drawingInfo)!==r.toJson(c.layerDefinition.drawingInfo)&&delete c.layerDefinition.drawingInfo;e.layerDefinition.showLegend!==c.layerDefinition.showLegend&&delete c.layerDefinition.showLegend;e.layerDefinition=dojo.mixin(e.layerDefinition,
c.layerDefinition)}else e.layerDefinition=c.layerDefinition;e.featureSet=c.featureSet;e.nextObjectId=c.nextObjectId}):(b.featureCollection=b.featureCollection||{},b.featureCollection=dojo.mixin(b.featureCollection,d.featureCollection));e.callback(b)});return e}function xa(a,b,d){var e=new h,f=[];c.forEach(b.layers,function(a){a.featureSet&&(a.featureSet.features&&a.featureSet.features.length&&a.featureSet.features[0].geometry&&a.featureSet.features[0].geometry.spatialReference)&&(a.deferredsPos=f.length,
f.push(D.projectFeatureCollection(a,d,a.featureSet.features[0].geometry.spatialReference)))});(new n(f)).addCallback(function(){c.forEach(b.layers,function(b){esri.isDefined(b.deferredsPos)&&(f[b.deferredsPos].results&&f[b.deferredsPos].results.length?b=f[b.deferredsPos].results[0]:(console.log("Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"),b.errors=b.errors||[],b.errors.push({message:"Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+
"]"})),delete b.deferredsPos)});e.callback(b)});return e}function U(a,b,d,e){var f=new h,g=[];c.forEach(a.operationalLayers,function(a,b){a.itemId&&"Feature Collection"==a.type&&g.push(va(a).then(k.hitch(null,wa,a,d)))});0==g.length?ya(a,b,d,e,f):(new n(g)).addCallback(function(c){ya(a,b,d,e,f)});return f}function ya(a,b,d,e,f){var g=[],h=[],k=[];c.forEach(a.operationalLayers,function(a,b){a.featureCollection?c.forEach(a.featureCollection.layers,function(d,e){var f=!0;a.visibleLayers&&-1==c.indexOf(a.visibleLayers,
e)&&(f=!1);d.visibility=a.visibility&&f;d.opacity=a.opacity;d.id=(a.id||"operational"+b)+"_"+e;k.push(d)},this):k.push(a)});c.forEach(a.baseMap.baseMapLayers,function(a,b){a.baseMapLayer=!0;a.id=a.id||"base"+b;g.push(a)});c.forEach(k,function(a,b){a.id=a.id||"operational"+b;g.push(a)});c.forEach(g,function(a){a.url&&!a.type?(a.deferredsPos=h.length,a.errors=a.errors||[],h.push(ua(a.url,a.errors))):a.url&&"CSV"==a.type&&(a.deferredsPos=h.length,h.push(D.buildCSVFeatureCollection(a)))});0==h.length?
(d=d||la(g),g=T(g,b,d,e),f.callback(g)):(new n(h)).addCallback(function(a){ta(a,g,b,h,f,d,e)});return f}function V(a,b,d,e){var f=a.minScale,g=a.maxScale;if(10.1>=d.version&&b)for(a=b.length-1;0<=a;a--){if(b[a].id==e)if(0==f&&0<b[a].minScale?f=b[a].minScale:0<f&&0==b[a].minScale?f=d.minScale:0<f&&0<b[a].minScale&&(f=Math.min(f,b[a].minScale)),g=Math.max(d.maxScale||0,b[a].maxScale||0),d.setScaleRange(f,g),-1<b[a].parentLayerId)e=b[a].parentLayerId;else break}else 10.1<d.version&&(c.forEach(a.layerInfos,
function(a){a.id==e&&(0==f&&0<a.minScale?f=a.minScale:0<f&&0==a.minScale||0<f&&0<a.minScale&&(f=Math.min(f,a.minScale)),g=Math.max(g||0,a.maxScale||0))}),d.setScaleRange(f,g))}function W(b,d,e,f){var g=b.url,h=b.__popupIds,m=b.__popupUrls,l=b.__popupWhereClauses,n=b.__popupMinScales,p=b.__popupMaxScales,r=b.__resourceInfo,s=[];c.forEach(b.__popups,function(f,k){if(f){var I,u=[];c.forEach(f.fieldInfos,function(a){"shape"!==a.fieldName.toLowerCase()&&u.push(a.fieldName)});if(b.dynamicLayerInfos&&0<
b.dynamicLayerInfos.length){var v=c.filter(b.dynamicLayerInfos,function(a){return h[k]==a.id})[0].source;I=new J(g+"/dynamicLayer",{id:b.id+"_"+h[k],source:v,outFields:u,mode:J.MODE_SELECTION,infoTemplate:f&&new e(f),drawMode:!1,visible:b.visible,autoGeneralize:!0});var x=function(c,e){0<l[c].length&&e.setDefinitionExpression(l[c]);if(!a.isDefined(n[c])&&!a.isDefined(p[c]))V(b,d||r.layers,e,h[c]);else if(a.isDefined(b.minScale)||a.isDefined(b.maxScale)){var f=b.minScale,g=b.maxScale;0==f&&0<n[c]?
f=n[c]:0<f&&0==n[c]||0<f&&0<n[c]&&(f=Math.min(f,n[c]));g=Math.max(g||0,p[c]||0);e.setScaleRange(f,g)}else e.setScaleRange(n[c],p[c])};I.loaded?x(k,I):q.connect(I,"onLoad",function(a){x(k,I)})}else{var t,v=null;if(d)for(t=0;t<d.length;t++)if(d[t].id===h[k]){v=d[t];break}t=g+"/"+h[k];m[k].length&&(t=m[k]);I=new J(A(t),{id:b.id+"_"+h[k],outFields:u,mode:J.MODE_SELECTION,infoTemplate:f&&new e(f),drawMode:!1,visible:b.visible,resourceInfo:v,autoGeneralize:!0});I.loaded?(0<l[k].length&&I.setDefinitionExpression(l[k]),
V(b,d||r.layers,I,h[k])):q.connect(I,"onLoad",function(a){0<l[k].length&&I.setDefinitionExpression(l[k]);V(b,d||r.layers,a,h[k])})}s.push(I)}});0<s.length&&(q.connect(b,"onVisibilityChange",k.hitch(this,function(a,b){c.forEach(a,function(a){b?a.show():a.hide()})},s)),q.connect(f,"onLayerRemove",k.hitch(this,function(a,b,d){a.id===d.id&&c.forEach(b,function(a){f.removeLayer(a)})},b,s)));delete b.__popups;delete b.__popupIds;delete b.__popupUrls;delete b.__popupWhereClauses;delete b.__popupMinScales;
delete b.__popupMaxScales;delete b.__resourceInfo;return s}function za(a){return s({url:A(a.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function Aa(a,b,d){var e=[];c.forEach(a,function(a){var b=a.__popups;b&&(1<b.length&&10<=a.version)&&(a.__deferredsPos=e.length,e.push(za(a)))});var f=[];0<e.length?(new n(e)).addCallback(function(e){c.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(a.__deferredsPos||0===a.__deferredsPos?(f=f.concat(W(a,e[a.__deferredsPos][1].layers,
d,b)),delete a.__deferredsPos):f=f.concat(W(a,null,d,b)))});b.addLayers(f)}):(c.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(f=f.concat(W(a,null,d,b)))}),b.addLayers(f))}function Ba(a){c.forEach(a,function(a){var b=a.layer;b.toJson&&(a=b.toJson(),a.featureSet&&-1<b.name.indexOf("Text")&&c.forEach(a.featureSet.features,function(a,c){if(a.attributes.TEXT){var d=b.graphics[c];d.symbol.setText(a.attributes.TEXT);a.symbol.horizontalAlignment&&(d.symbol.align=a.symbol.horizontalAlignment);d.setSymbol(d.symbol);
d.setAttributes(a.attributes)}},this))})}function Ca(a){var b=6;c.forEach(a,function(a){if(a=a.renderer)"esri.renderer.SimpleRenderer"===a.declaredClass?((a=a.symbol)&&a.xoffset&&(b=Math.max(b,Math.abs(a.xoffset))),a&&a.yoffset&&(b=Math.max(b,Math.abs(a.yoffset)))):("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)&&c.forEach(a.infos,function(a){(a=a.symbol)&&a.xoffset&&(b=Math.max(b,Math.abs(a.xoffset)));a&&a.yoffset&&(b=Math.max(b,Math.abs(a.yoffset)))})});
return b}function X(a){var b=this,d=b.infoWindow,e=a.graphic;if(b.loaded){d.hide();d.clearFeatures();var f=[];c.forEach(b.graphicsLayerIds,function(a){if((a=b.getLayer(a))&&-1!==a.declaredClass.indexOf("FeatureLayer")&&a.loaded&&a.visible)a.clearSelection(),a.infoTemplate&&!a.suspended&&f.push(a)});c.forEach(b.layerIds,function(a){(a=b.getLayer(a))&&(-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")&&a.loaded&&a.visible&&a.infoTemplate)&&f.push(a)});e=e&&e.getInfoTemplate()?e:null;if(f.length||
e){var g=Ca(f),k=a.screenPoint,l=b.toMap(new x(k.x-g,k.y+g)),g=b.toMap(new x(k.x+g,k.y-g)),l=new B(l.x,l.y,g.x,g.y,b.spatialReference),m=new u;m.geometry=l;m.timeExtent=b.timeExtent;var n=!0,l=c.map(f,function(a){var b;-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?(n=!1,b=a.queryVisibleRasters(m,{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),b.addCallback(function(){return a.getVisibleRasters()})):(b=a.selectFeatures(m),b.addCallback(function(){return a.getSelectedFeatures()}));
return b});e&&(g=new h,g.callback([e]),l.splice(0,0,g));if(!c.some(l,function(a){return-1===a.fired})){var p=e?1:0;c.forEach(f,function(a){p=-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?p+a.getVisibleRasters().length:p+a.getSelectedFeatures().length});if(!p)return}d.setFeatures(l);d.show(a.mapPoint,{closestFirst:n})}}}function Ma(c,d){var e=d.mapOptions||{},g;e.infoWindow||(g=new y({visibleWhenEmpty:!1},b.create("div")),e.infoWindow=g);a.isDefined(e.showInfoWindowOnClick)||(e.showInfoWindowOnClick=
!1);e=new f(c,e);q.connect(e,"onLayersAddResult",Ba);return e}function L(a,b,d,e,f,g){var h,k,l;e.map?(h=e.map,k=e.clickEventHandle,l=e.errors):(h=Ma(e,f),!f.ignorePopups&&!f.disableClickBehavior&&(k=q.connect(h,"onClick",X)));f.ignorePopups&&c.forEach(a,function(a){delete a.infoTemplate});h.addLayers(a);f.ignorePopups||Aa(a,h,f._clazz);var m=l||[];c.forEach(b,function(a){a.errors&&(m=m.concat(a.errors))},this);h.loaded?g.callback({map:h,itemInfo:d,errors:m,clickEventHandle:k,clickEventListener:X}):
q.connect(h,"onLoad",function(){g.callback({map:h,itemInfo:d,errors:m,clickEventHandle:k,clickEventListener:X})})}function Y(a,b,d,e,f){var g=[];c.forEach(f,function(a){k.isArray(a.layerObject)?c.forEach(a.layerObject,function(a){g.push(a)}):g.push(a.layerObject)});if("BingMapsAerial"===f[0].type||"BingMapsRoad"===f[0].type||"BingMapsHybrid"===f[0].type)var h=setInterval(function(){if(f[0].layerObject&&f[0].layerObject.loaded)clearInterval(h),Da(a,b,d,e,f,g);else if(f[0].errors){clearInterval(h);
var c="";f[0].errors&&f[0].errors.length&&(c=" ("+f[0].errors[0].message+")");e.errback(Error(fa.arcgis.utils.baseLayerError+c))}},10);else if(!g[0]&&f[0].baseMapLayer){var l="";f[0].errors&&f[0].errors.length&&(l=" ("+f[0].errors[0].message+")");e.errback(Error(fa.arcgis.utils.baseLayerError+l))}else Da(a,b,d,e,f,g)}function Da(b,d,f,g,h,k){try{var m=f.mapOptions||{};f.mapOptions=m;var n=b.item;k=c.filter(k,a.isDefined);if(n)if(n.extent&&n.extent.length)if(m.extent)L(k,h,b,d,f,g);else{var p=new B(n.extent[0][0],
n.extent[0][1],n.extent[1][0],n.extent[1][1],new e({wkid:4326})),q=k[0].spatialReference;4326===q.wkid?(m.extent=p,L(k,h,b,d,f,g)):102100===q.wkid||102113===q.wkid||3857===q.wkid?(p.xmin=Math.max(p.xmin,-180),p.xmax=Math.min(p.xmax,180),p.ymin=Math.max(p.ymin,-89.99),p.ymax=Math.min(p.ymax,89.99),m.extent=t.geographicToWebMercator(p),L(k,h,b,d,f,g)):f.geometryServiceURL||l.defaults.geometryService?(f.geometryServiceURL?new z(f.geometryServiceURL):l.defaults.geometryService).project([p],q,function(a){a=
a[0];m.extent=m.extent||a;L(k,h,b,d,f,g)},function(){L(k,h,b,d,f,g)}):g.errback(Error(fa.arcgis.utils.geometryServiceError))}else L(k,h,b,d,f,g);else L(k,h,b,d,f,g)}catch(r){g.errback(r)}}function Ea(a){var b=[];a=a.baseMap.baseMapLayers.concat(a.operationalLayers);c.forEach(a,function(a,d){var e={};if(a.featureCollection&&"CSV"!==a.type)!0===a.featureCollection.showLegend&&c.forEach(a.featureCollection.layers,function(c){!1!==c.showLegend&&(e={layer:c.layerObject,title:a.title,defaultSymbol:c.renderer&&
c.renderer.defaultSymbol&&c.renderer.defaultLabel?!0:!1},1<a.featureCollection.layers.length&&(e.title+=" - "+c.layerDefinition.name),b.push(e))});else if(a.baseMapLayer&&!0===a.showLegend&&a.layerObject||!a.baseMapLayer&&!1!==a.showLegend&&a.layerObject){var f=a.layerObject.renderer,f=!f||f&&f.defaultSymbol&&f.defaultLabel?!0:!1;if(10.1>a.layerObject.version&&(a.layerObject instanceof N||a.layerObject instanceof F)||a.layerObject instanceof esri.layers.ArcGISImageServiceLayer)f=!0;e={layer:a.layerObject,
title:a.title,defaultSymbol:f};a.layers&&(f=c.map(c.filter(a.layers,function(a){return!1===a.showLegend}),function(a){return a.id}),f.length&&(e.hideLayers=f));b.push(e)}});return b}function Fa(a,b,d,e){if(!e.itemData.operationalLayers||0===e.itemData.operationalLayers.length)S(e,b).addCallback(function(c){U(c.itemData,b).addCallback(k.hitch(null,Y,c,a,b,d))});else{var f=new h,g=e.itemData.baseMap.baseMapLayers.slice(0),l=c.filter(e.itemData.baseMap.baseMapLayers,function(a){return!a.isReference}),
m={item:e.item,itemData:{baseMap:{baseMapLayers:l}}};e.itemData.baseMap.baseMapLayers=c.filter(e.itemData.baseMap.baseMapLayers,function(a){return a.isReference});S(m,b).addCallback(function(c){U(c.itemData,b).addCallback(k.hitch(null,Y,c,a,b,f))});f.then(function(a){S(e,b).addCallback(function(c){U(c.itemData,b,a.map.spatialReference,l).addCallback(function(e){c.itemData.baseMap.baseMapLayers=g;Y(c,a,b,d,e)})})},k.hitch(d,d.errback))}}function Ga(a){C._arcgisUrl&&0<C._arcgisUrl.length&&(C.arcgisUrl=
C._arcgisUrl);var b=C.arcgisUrl+"/"+a,c={},d=new h;s({url:b,content:{f:"json"},callbackParamName:"callback",load:function(a){c.item=a;s({url:b+"/data",content:{f:"json"},callbackParamName:"callback",load:function(a){c.itemData=a;d.callback(c)},error:function(a){d.errback(a)}})},error:function(a){d.errback(a)}});return d}String.prototype.endsWith=function(a){return this.match(a+"$")==a};var C;C={arcgisUrl:location.protocol+"//www.arcgis.com/sharing/rest/content/items",getItem:Ga,createMap:function(a,
b,c){var d=new h;c=c||{};var e=c.infoTemplateClass;c._clazz=e&&(k.isObject(e)?e:k.getObject(e))||H;k.isString(a)?Ga(a).addCallback(k.hitch(null,Fa,b,c,d)).addErrback(k.hitch(d,d.errback)):Fa(b,c,d,a);return d},getLegendLayers:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?Ea(a.itemInfo.itemData):[]},_arcgisUrl:null,_getItemProps:S,_getItemData:Q,_getBingKey:ma,_processFSItemProperties:na,_getLayers:U,_preBuildLayerObjects:ta,_buildLayerObjects:T,_preCreateMap:Y,_getMapSR:la,_createMap:L,_addSelectionLayers:Aa,
_createSelectionFeatureLayers:W,_getServiceInfo:ua,_getFeatureCollectionItem:va,_mergeFeatureCollectionItem:wa,_projectFeatureCollection:xa,_getLayersInfo:za,_initLayer:ka,_loadAsCached:E,_loadAsDynamic:qa,_processPopups:ga,_onLayersAddResult:Ba,_sameSpatialReferenceAsBasemap:ia,_sameTilingSchemeAsBasemap:ja,_showPopup:X,_calculateClickTolerance:Ca,_getVisibleFeatureLayers:ha,_updateLayerScaleInfo:V,_checkUrl:A,_isHostedService:oa,_isAgolService:pa,_getLegendLayers:Ea};k.setObject("arcgis.utils",
C,m);return C});